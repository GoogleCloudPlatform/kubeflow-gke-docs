<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.105.0">
<link rel="canonical" type="text/html" href="https://googlecloudplatform.github.io/kubeflow-gke-docs/dev/docs/pipelines/">
<link rel="alternate" type="application/rss&#43;xml" href="https://googlecloudplatform.github.io/kubeflow-gke-docs/dev/docs/pipelines/index.xml">
<meta name="robots" content="noindex, nofollow">

<script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "WebSite",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/googlecloudplatform.github.io\/kubeflow-gke-docs\/dev"
      },
      "articleSection" : "docs",
      "name" : "Pipelines on Google Cloud",
      "headline" : "Pipelines on Google Cloud",
      "description" : "Instructions for customizing and using Kubeflow Pipelines on Google Cloud",
      "inLanguage" : "en-US",
      "author" : "",
      "creator" : "",
      "publisher": "",
      "accountablePerson" : "",
      "copyrightHolder" : "",
      "copyrightYear" : "0001",
      "datePublished": "0001-01-01 00:00:00 \u002b0000 UTC",
      "dateModified" : "0001-01-01 00:00:00 \u002b0000 UTC",
      "url" : "https:\/\/googlecloudplatform.github.io\/kubeflow-gke-docs\/dev\/docs\/pipelines\/",
      "wordCount" : "0",
      "keywords" : [ "Kubeflow on GCP" ]
  }
  </script>

<link rel="shortcut icon" href="/kubeflow-gke-docs/dev/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/kubeflow-gke-docs/dev/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/kubeflow-gke-docs/dev/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/kubeflow-gke-docs/dev/favicons/favicon-32x32.png" sizes="32x32">
<link rel="manifest" href="/kubeflow-gke-docs/dev/favicons/manifest.json">
<meta name="msapplication-config" content="/kubeflow-gke-docs/dev/favicons/browserconfig.xml" />
<meta name="msapplication-TileColor" content="#4279f4">
<meta name="theme-color" content="#4279f4">

<title>Pipelines on Google Cloud | Kubeflow on Google Cloud Platform</title>
<meta name="description" content="Instructions for customizing and using Kubeflow Pipelines on Google Cloud">
<meta property="og:title" content="Pipelines on Google Cloud" />
<meta property="og:description" content="Instructions for customizing and using Kubeflow Pipelines on Google Cloud" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://googlecloudplatform.github.io/kubeflow-gke-docs/dev/docs/pipelines/" /><meta property="og:site_name" content="Kubeflow on Google Cloud Platform" />

<meta itemprop="name" content="Pipelines on Google Cloud">
<meta itemprop="description" content="Instructions for customizing and using Kubeflow Pipelines on Google Cloud"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Pipelines on Google Cloud"/>
<meta name="twitter:description" content="Instructions for customizing and using Kubeflow Pipelines on Google Cloud"/>




<link rel="preload" href="/kubeflow-gke-docs/dev/scss/main.min.5006b434b14f73c3d5537a7ba4c8ecef723ddc93f3a3c8530e19d24f75486ea9.css" as="style">
<link href="/kubeflow-gke-docs/dev/scss/main.min.5006b434b14f73c3d5537a7ba4c8ecef723ddc93f3a3c8530e19d24f75486ea9.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-GK9XL47N6S"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GK9XL47N6S', { 'anonymize_ip': false });
}
</script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand-md navbar-dark  td-navbar">
        <a class="navbar-brand" href="/kubeflow-gke-docs/dev/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 276.93 274.55"><g data-name="Layer 2"><g data-name="Layer 1"><path d="M95.9 62.15l4.1 102.1 73.75-94.12a6.79 6.79.0 019.6-1.11l46 36.92-15-65.61z" fill="#4279f4"/><path fill="#0028aa" d="M102.55 182.98h65.42l-40.17-32.23-25.25 32.23z"/><path fill="#014bd1" d="M180.18 83.92l-44 56.14 46.88 37.61 44.47-55.76-47.35-37.99z"/><path fill="#bedcff" d="M83.56 52.3l.01-.01 38.69-48.52-62.39 30.05-15.41 67.51 39.1-49.03z"/><path fill="#6ca1ff" d="M45.32 122.05l41.44 51.96-3.95-98.98-37.49 47.02z"/><path fill="#a1c3ff" d="M202.31 28.73 142.65.0l-37.13 46.56 96.79-17.83z"/><path d="M1.6 272v-44.78h5.74v23.41l20.48-23.41h6.4l-17.39 19.7 19 25.07H29.1l-15.92-20.8-5.84 6.65V272zm40.02-9.79V240h5.43v22.39a4.67 4.67.0 002.35 4.19 11 11 0 0011 0 4.69 4.69.0 002.33-4.19V240h5.43v22.19a9.08 9.08.0 01-4.1 7.87 16.2 16.2.0 01-18.37.0 9.07 9.07.0 01-4.07-7.85zM77.46 272v-48h5.43v16.81a29.29 29.29.0 019.32-1.73 13.1 13.1.0 016.2 1.41 10.71 10.71.0 014.18 3.74 18.07 18.07.0 012.23 5.06 21.26 21.26.0 01.73 5.58q0 8.43-4.38 12.79T87.35 272zm5.43-4.87h4.55q6.77.0 9.72-2.95t3-9.51a14.21 14.21.0 00-2-7.52 6.55 6.55.0 00-6-3.22 24.73 24.73.0 00-9.25 1.54zm29.47-11.19q0-7.71 4.09-12.3a13.75 13.75.0 0110.8-4.59q13.35.0 13.36 18.86h-22.82a12.3 12.3.0 002.9 7.07q2.59 3.11 7.9 3.1a24.92 24.92.0 0010.55-2v5a27.74 27.74.0 01-9.86 1.87 19.83 19.83.0 01-7.7-1.37 13.31 13.31.0 01-5.28-3.76 16.21 16.21.0 01-3-5.38 20.84 20.84.0 01-.94-6.5zm5.62-2.12h17.26a14.91 14.91.0 00-2.37-7.12 6.44 6.44.0 00-5.62-2.78 8.2 8.2.0 00-6.21 2.72 12.07 12.07.0 00-3.04 7.18z" fill="#4279f4" stroke="#4279f4" stroke-miterlimit="10" stroke-width="3.2"/><path d="M147.32 244.89V240h5v-7.59a8.14 8.14.0 012.31-6.05 7.79 7.79.0 015.69-2.28h7.86V229h-5c-2.21.0-3.67.45-4.37 1.34s-1.06 2.55-1.06 5V240h8.46v4.87h-8.46V272h-5.44v-27.1zM175.26 272v-48h5.43v48zm19.15-3.95a17.86 17.86.0 1112.33 4.9 16.57 16.57.0 01-12.33-4.9zm3.84-20.65a13.16 13.16.0 000 17.2 12.07 12.07.0 0017 0 13.09 13.09.0 000-17.2 12.07 12.07.0 00-17 0zm30.2-7.4h5.75l7.3 25.32 7.43-25.32h5.36l7.34 25.34L269 240h5.74l-10.04 32h-6.12l-6.83-24.58L245 272h-6.47z" fill="#0028aa" stroke="#0028aa" stroke-miterlimit="10" stroke-width="3.2"/></g></g></svg></span><span class="text-uppercase font-weight-bold">Kubeflow on Google Cloud Platform</span>
	</a>
	<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main_navbar" aria-controls="main_navbar" aria-expanded="false" aria-label="Toggle navigation">
		<span class="navbar-toggler-icon"></span>
	</button>
	<div class="collapse navbar-collapse ml-md-auto" id="main_navbar">
		<ul class="navbar-nav ml-auto pt-4 pt-md-0 my-2 my-md-1">
			
			
			<li class="nav-item mr-2 mr-lg-4 mt-1 mt-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/kubeflow-gke-docs/dev/docs/" ><span>Docs</span></a>
			</li>
			
			<li class="nav-item mr-2 mr-lg-4 mt-1 mt-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="https://github.com/googlecloudplatform/kubeflow-distribution" target="_blank" ><i class='fa-brands fa-github pr-2'></i><span>Manifests</span></a>
			</li>
			
			
			<li class="nav-item dropdown mt-1 mt-lg-0 mr-2">
				<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	dev
</a>
<div class="dropdown-menu dropdown-menu-md-right dropdown-menu-lg-left" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="https://googlecloudplatform.github.io/kubeflow-gke-docs/docs">v1.6 (latest)</a>
	
	<a class="dropdown-item" href="https://googlecloudplatform.github.io/kubeflow-gke-docs/v1.5/docs">v1.5</a>
	
	<a class="dropdown-item" href="https://googlecloudplatform.github.io/kubeflow-gke-docs/v1.4/docs">v1.4</a>
	
	<a class="dropdown-item" href="https://googlecloudplatform.github.io/kubeflow-gke-docs/dev/docs">dev</a>
	
</div>

			</li>
			
			
		</ul>
	</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/kubeflow-gke-docs/dev/docs/pipelines/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Pipelines on Google Cloud</h1>
<div class="lead">Instructions for customizing and using Kubeflow Pipelines on Google Cloud</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-0b0498d20bf77acec45ad87018b21f47">Connecting to Kubeflow Pipelines on Google Cloud using the SDK</a></li>


    
  
    
    
	
<li>2: <a href="#pg-25e5f676d4864c88d4a268fec2aaca06">Authenticating Pipelines to Google Cloud</a></li>


    
  
    
    
	
<li>3: <a href="#pg-e8f58dfedb7f24d2f30aab8ff214e5d9">Upgrading</a></li>


    
  
    
    
	
<li>4: <a href="#pg-d79816c8e6fac2f07383ee4b56fd17de">Enabling GPU and TPU</a></li>


    
  
    
    
	
<li>5: <a href="#pg-ee70eee465844b15b58f4b4844b00eab">Using Preemptible VMs and GPUs on Google Cloud</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-0b0498d20bf77acec45ad87018b21f47">1 - Connecting to Kubeflow Pipelines on Google Cloud using the SDK</h1>
    <div class="lead">How to connect to different Kubeflow Pipelines installations on Google Cloud using the Kubeflow Pipelines SDK</div>
	<p>This guide describes how to connect to your Kubeflow Pipelines cluster on Google
Cloud using <a href="https://www.kubeflow.org/docs/components/pipelines/overview/">the Kubeflow Pipelines SDK</a>.</p>
<h2 id="before-you-begin">Before you begin</h2>
<ul>
<li>You need a Kubeflow Pipelines deployment on Google Cloud using one of the <a href="https://www.kubeflow.org/docs/components/pipelines/installation/overview/">installation options</a>.</li>
<li><a href="https://www.kubeflow.org/docs/components/pipelines/sdk/install-sdk/">Install the Kubeflow Pipelines SDK</a>.</li>
</ul>
<h2 id="how-sdk-connects-to-kubeflow-pipelines-api">How SDK connects to Kubeflow Pipelines API</h2>
<p>Kubeflow Pipelines includes an API service named <code>ml-pipeline-ui</code>. The
<code>ml-pipeline-ui</code> API service is deployed in the same Kubernetes namespace you
deployed Kubeflow Pipelines in.</p>
<p>The Kubeflow Pipelines SDK can send REST API requests to this API service, but
the SDK needs to know the hostname to connect to the API service.</p>
<p>If the hostname can be accessed without authentication, it&rsquo;s very simple to
connect to it. For example, you can use <code>kubectl port-forward</code> to access it via
localhost:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># The Kubeflow Pipelines API service and the UI is available at</span>
</span></span><span class="line"><span class="cl"><span class="c1"># http://localhost:3000 without authentication check.</span>
</span></span><span class="line"><span class="cl">$ kubectl port-forward svc/ml-pipeline-ui 3000:80 --namespace kubeflow
</span></span><span class="line"><span class="cl"><span class="c1"># Change the namespace if you deployed Kubeflow Pipelines in a different</span>
</span></span><span class="line"><span class="cl"><span class="c1"># namespace.</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">kfp</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">kfp</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;http://localhost:3000&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>When deploying Kubeflow Pipelines on Google Cloud, a public endpoint for this
API service is auto-configured for you, but this public endpoint has security
checks to protect your cluster from unauthorized access.</p>
<p>The following sections introduce how to authenticate your SDK requests to connect
to Kubeflow Pipelines via the public endpoint.</p>
<h2 id="connecting-to-kubeflow-pipelines-standalone-or-ai-platform-pipelines">Connecting to Kubeflow Pipelines standalone or AI Platform Pipelines</h2>
<p>Refer to <a href="https://cloud.google.com/ai-platform/pipelines/docs/connecting-with-sdk">Connecting to AI Platform Pipelines using the Kubeflow Pipelines SDK</a> for
both Kubeflow Pipelines standalone and AI Platform Pipelines.</p>
<p>Kubeflow Pipelines standalone deployments also show up in <a href="https://console.cloud.google.com/ai-platform/pipelines/clusters">AI Platform Pipelines</a>. They have the
name &ldquo;pipeline&rdquo; by default, but you can customize the name by overriding
<a href="https://github.com/kubeflow/pipelines/blob/sdk/release-1.8/manifests/kustomize/sample/params.env#L1">the <code>appName</code> parameter in <code>params.env</code></a> when <a href="https://www.kubeflow.org/docs/components/pipelines/installation/standalone-deployment/">deploying Kubeflow Pipelines standalone</a>.</p>
<h2 id="connecting-to-kubeflow-pipelines-in-a-full-kubeflow-deployment">Connecting to Kubeflow Pipelines in a full Kubeflow deployment</h2>
<p>A full Kubeflow deployment on Google Cloud uses an <a href="https://cloud.google.com/iap/docs">Identity-Aware Proxy (IAP)</a> to manage access to the public Kubeflow endpoint. The steps
below let you connect to Kubeflow Pipelines in a full Kubeflow deployment with
authentication through IAP.</p>
<ol>
<li>
<p>Find out your IAP OAuth 2.0 client ID.</p>
<p>You or your cluster admin followed <a href="../../deploy/oauth-setup/">Set up OAuth for Cloud IAP</a>
to deploy your full Kubeflow deployment on Google Cloud. You need the OAuth client
ID created in that step.</p>
<p>You can browse all of your existing OAuth client IDs <a href="https://console.cloud.google.com/apis/credentials">in the Credentials page of Google Cloud Console</a>.</p>
</li>
<li>
<p>Create another SDK OAuth Client ID for authenticating Kubeflow Pipelines SDK users.
Follow <a href="https://cloud.google.com/iap/docs/authentication-howto#authenticating_from_a_desktop_app">the steps to set up a client ID to authenticate from a desktop app</a>. Take
a note of the <strong>client ID</strong> and <strong>client secret</strong>. This client ID and secret can
be shared among all SDK users, because a separate login step is still needed below.</p>
</li>
<li>
<p>To connect to Kubeflow Pipelines public endpoint, initiate SDK client like the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">kfp</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">kfp</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;https://&lt;KF_NAME&gt;.endpoints.&lt;PROJECT&gt;.cloud.goog/pipeline&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">client_id</span><span class="o">=</span><span class="s1">&#39;&lt;AAAAAAAAAAAAAAAAAAAAAA&gt;.apps.googleusercontent.com&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">other_client_id</span><span class="o">=</span><span class="s1">&#39;&lt;BBBBBBBBBBBBBBBBBBB&gt;.apps.googleusercontent.com&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">other_client_secret</span><span class="o">=</span><span class="s1">&#39;&lt;CCCCCCCCCCCCCCCCCCCC&gt;&#39;</span><span class="p">)</span>
</span></span></code></pre></div><ul>
<li>Pass your <strong>IAP</strong> OAuth client ID found in <strong>step 1</strong> to <code>client_id</code> argument.</li>
<li>Pass your <strong>SDK</strong> OAuth client ID and secret created in <strong>step 2</strong> to <code>other_client_id</code>
and <code>other_client_secret</code> arguments.</li>
</ul>
</li>
<li>
<p>When you init the SDK client for the first time, you will be asked to log in.
The Kubeflow Pipelines SDK stores obtained credentials in <code>$HOME/.config/kfp/credentials.json</code>. You do not need to log in again unless you manually delete the credentials file.</p>
<pre><code>To use the SDK from cron tasks where you cannot log in manually, you can copy the credentials file in `$HOME/.config/kfp/credentials.json` to another machine.
However, you should keep the credentials safe and never expose it to
third parties.
</code></pre>
</li>
<li>
<p>After login, you can use the client.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">list_pipelines</span><span class="p">())</span>
</span></span></code></pre></div></li>
</ol>
<h2 id="troubleshooting">Troubleshooting</h2>
<ul>
<li>
<p>Error &ldquo;Failed to authorize with API resource references: there is no user identity header&rdquo; when using SDK methods.</p>
<p>Direct access to the API service without authentication works for Kubeflow
Pipelines standalone, AI Platform Pipelines, and Kubeflow 1.0 or earlier.</p>
<p>However, it fails authorization checks for Kubeflow Pipelines with multi-user
isolation in the full Kubeflow deployment starting from Kubeflow 1.1.
Multi-user isolation requires all API access to authenticate as a user. Refer to <a href="https://www.kubeflow.org/docs/components/pipelines/overview/multi-user/">Kubeflow Pipelines Multi-user isolation documentation</a>
for more details.</p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-25e5f676d4864c88d4a268fec2aaca06">2 - Authenticating Pipelines to Google Cloud</h1>
    <div class="lead">Authentication and authorization to Google Cloud in Pipelines</div>
	<p>This page describes authentication for Kubeflow Pipelines to Google Cloud.
Available options listed below have different tradeoffs. You should choose the one that fits your use-case.</p>
<ul>
<li>Configuring your cluster to access Google Cloud using <a href="#compute-engine-default-service-account">Compute Engine default service account</a> with the &ldquo;cloud-platform&rdquo; scope is easier to set up than the other options. However, this approach grants excessive permissions. Therefore, it is not suitable if you need workload permission separation.</li>
<li><a href="#workload-identity">Workload Identity</a> takes more efforts to set up, but allows fine-grained permission control. It is recommended for production use-cases.</li>
<li><a href="#google-service-account-keys-stored-as-kubernetes-secrets">Google service account keys stored as Kubernetes secrets</a> is the legacy approach and no longer recommended in Google Kubernetes Engine. However, it&rsquo;s the only option to use Google Cloud APIs when your cluster is an <a href="https://cloud.google.com/anthos">anthos</a> or on-prem cluster.</li>
</ul>
<h2 id="before-you-begin">Before you begin</h2>
<p>There are various options on how to install Kubeflow Pipelines in the <a href="https://www.kubeflow.org/docs/components/pipelines/installation/overview/">Installation Options for Kubeflow Pipelines</a> guide.
Be aware that authentication support and cluster setup instructions will vary depending on the method you used to install Kubeflow Pipelines.</p>
<ul>
<li>For Kubeflow Pipelines standalone, you can compare and choose from all 3 options.</li>
<li>For full Kubeflow starting from Kubeflow 1.1, <a href="#workload-identity">Workload Identity</a> is the recommended and default option.</li>
<li>For AI Platform Pipelines, <a href="#compute-engine-default-service-account">Compute Engine default service account</a> is the only supported option.</li>
</ul>
<h2 id="compute-engine-default-service-account">Compute Engine default service account</h2>
<p>This is good for trying out Kubeflow Pipelines, because it is easy to set up.</p>
<p>However, it does not support permission separation for workloads in the cluster. <strong>Any workload</strong> in the cluster will be able to call <strong>any Google Cloud APIs</strong> in the chosen scope.</p>


<div class="alert alert-warning" role="alert">


    NOTE: Using pipelines with Compute Engine default service account is not supported in Full Kubeflow deployment.

</div>

<h3 id="cluster-setup-to-use-compute-engine-default-service-account">Cluster setup to use Compute Engine default service account</h3>
<p>By default, your Google Kubernetes Engine nodes use <a href="https://cloud.google.com/compute/docs/access/service-accounts#default_service_account">Compute Engine default service account</a>. If you allowed <code>cloud-platform</code> scope when creating the cluster,
Kubeflow Pipelines can authenticate to Google Cloud and manage resources in your project without further configuration.</p>
<p>Use one of the following options to create a Google Kubernetes Engine cluster that uses the Compute Engine default service account:</p>
<ul>
<li>If you followed instructions in <a href="https://cloud.google.com/ai-platform/pipelines/docs/setting-up">Setting up AI Platform Pipelines</a> and checked <code>Allow access to the following Cloud APIs</code>, your cluster is already using Compute Engine default service account.</li>
<li>In Google Cloud Console UI, you can enable it in <code>Create a Kubernetes cluster -&gt; default-pool -&gt; Security -&gt; Access Scopes -&gt; Allow full access to all Cloud APIs</code> like the following:
<img src="../../images/pipelines/v1/gke-allow-full-access.png"></li>
<li>Using <code>gcloud</code> CLI, you can enable it with <code>--scopes cloud-platform</code> like the following:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcloud container clusters create &lt;cluster-name&gt; <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --scopes cloud-platform
</span></span></code></pre></div><p>Please refer to <a href="https://cloud.google.com/sdk/gcloud/reference/container/clusters/create#--scopes">gcloud container clusters create command documentation</a> for other available options.</p>
<h3 id="authoring-pipelines-to-use-default-service-account">Authoring pipelines to use default service account</h3>
<p>Pipelines don&rsquo;t need any specific changes to authenticate to Google Cloud, it will use the default service account transparently.</p>
<p>However, you must update existing pipelines that use the <a href="https://kubeflow-pipelines.readthedocs.io/en/stable/source/kfp.extensions.html#kfp.gcp.use_gcp_secret">use_gcp_secret kfp sdk operator</a>. Remove the <code>use_gcp_secret</code> usage to let your pipeline authenticate to Google Cloud using the default service account.</p>
<h2 id="securing-the-cluster-with-fine-grained-google-cloud-permission-control">Securing the cluster with fine-grained Google Cloud permission control</h2>
<h3 id="workload-identity">Workload Identity</h3>
<blockquote>
<p>Workload Identity is the recommended way for your Google Kubernetes Engine applications to consume services provided by Google APIs. You accomplish this by configuring a <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/">Kubernetes service account</a> to act as a <a href="https://cloud.google.com/iam/docs/service-accounts">Google service account</a>. Any Pods running as the Kubernetes service account then use the Google service account to authenticate to cloud services.</p>
</blockquote>
<p>Referenced from <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity">Workload Identity Documentation</a>. Please read this doc for:</p>
<ul>
<li>A detailed introduction to Workload Identity.</li>
<li>Instructions to enable it on your cluster.</li>
<li>Whether its limitations affect your adoption.</li>
</ul>
<h4 id="terminology">Terminology</h4>
<p>This document distinguishes between <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/">Kubernetes service accounts</a> (KSAs) and <a href="https://cloud.google.com/iam/docs/service-accounts">Google service accounts</a> (GSAs). KSAs are Kubernetes resources, while GSAs are specific to Google Cloud. Other documentation usually refers to both of them as just &ldquo;service accounts&rdquo;.</p>
<h4 id="authoring-pipelines-to-use-workload-identity">Authoring pipelines to use Workload Identity</h4>
<p>Pipelines don&rsquo;t need any specific changes to authenticate to Google Cloud. With Workload Identity, pipelines run as the Google service account that is bound to the KSA.</p>
<p>However, existing pipelines that use <a href="https://kubeflow-pipelines.readthedocs.io/en/stable/source/kfp.extensions.html#kfp.gcp.use_gcp_secret">use_gcp_secret kfp sdk operator</a> need to remove the <code>use_gcp_secret</code> usage to use the bound GSA.
You can also continue to use <code>use_gcp_secret</code> in a cluster with Workload Identity enabled and <code>use_gcp_secret</code> will take precedence for those workloads.</p>
<h4 id="cluster-setup-to-use-workload-identity-for-full-kubeflow">Cluster setup to use Workload Identity for Full Kubeflow</h4>
<p>Starting from Kubeflow 1.1, Kubeflow Pipelines supports multi-user isolation. Therefore, pipeline runs are executed in user namespaces using the <code>default-editor</code> KSA. The <code>default-editor</code> KSA is auto-bound to the GSA specified in the user profile, which defaults to a shared GSA <code>${KFNAME}-user@${PROJECT}.iam.gserviceaccount.com</code>.</p>
<p>If you want to bind the <code>default-editor</code> KSA with a different GSA for a specific namespace, refer to the <a href="../../authentication/#in-cluster-authentication">In-cluster authentication to Google Cloud</a> guide.</p>
<p>Additionally, the Kubeflow Pipelines UI, visualization, and TensorBoard server instances are deployed in your user namespace using the <code>default-editor</code> KSA. Therefore, to visualize results in the Pipelines UI, they can fetch artifacts in Google Cloud Storage using permissions of the same GSA you configured for this namespace.</p>
<h4 id="cluster-setup-to-use-workload-identity-for-pipelines-standalone">Cluster setup to use Workload Identity for Pipelines Standalone</h4>
<h5 id="1-create-your-cluster-with-workload-identity-enabled">1. Create your cluster with Workload Identity enabled</h5>
<ul>
<li>
<p>In Google Cloud Console UI, you can enable Workload Identity in <code>Create a Kubernetes cluster -&gt; Security -&gt; Enable Workload Identity</code> like the following:
<img src="../../images/pipelines/v1/gke-enable-workload-identity.png"></p>
</li>
<li>
<p>Using <code>gcloud</code> CLI, you can enable it with:</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcloud beta container clusters create &lt;cluster-name&gt; <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --release-channel regular <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --workload-pool<span class="o">=</span>project-id.svc.id.goog
</span></span></code></pre></div><p>References:</p>
<ul>
<li>
<p><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#enable_workload_identity_on_a_new_cluster">Enable Workload Identity on a new cluster</a></p>
</li>
<li>
<p><a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity#enable_workload_identity_on_an_existing_cluster">Enable Workload Identity on an existing cluster</a></p>
</li>
</ul>
<h5 id="2-deploy-kubeflow-pipelines">2. Deploy Kubeflow Pipelines</h5>
<p>Deploy via <a href="https://www.kubeflow.org/docs/components/pipelines/installation/overview/#kubeflow-pipelines-standalone">Pipelines Standalone</a> as usual.</p>
<h5 id="3-bind-workload-identities-for-ksas-used-by-kubeflow-pipelines">3. Bind Workload Identities for KSAs used by Kubeflow Pipelines</h5>
<p>The following helper bash scripts bind Workload Identities for KSAs used by Kubeflow Pipelines:</p>
<ul>
<li><a href="https://github.com/kubeflow/pipelines/blob/sdk/release-1.8/manifests/kustomize/gcp-workload-identity-setup.sh">gcp-workload-identity-setup.sh</a> helps you create GSAs and bind them to KSAs used by pipelines workloads. This script provides an interactive command line dialog with explanation messages.</li>
<li><a href="https://github.com/kubeflow/pipelines/blob/sdk/release-1.8/manifests/kustomize/wi-utils.sh">wi-utils.sh</a> alternatively provides minimal utility bash functions that let you customize your setup. The minimal utilities make it easy to read and use programmatically.</li>
</ul>
<p>For example, to get a default setup using <code>gcp-workload-identity-setup.sh</code>, you can</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ curl -O https://raw.githubusercontent.com/kubeflow/pipelines/master/manifests/kustomize/gcp-workload-identity-setup.sh
</span></span><span class="line"><span class="cl">$ chmod +x ./gcp-workload-identity-setup.sh
</span></span><span class="line"><span class="cl">$ ./gcp-workload-identity-setup.sh
</span></span><span class="line"><span class="cl"># This prints the command&#39;s usage example and introduction.
</span></span><span class="line"><span class="cl"># Then you can run the command with required parameters.
</span></span><span class="line"><span class="cl"># Command output will tell you which GSAs and Workload Identity bindings have been
</span></span><span class="line"><span class="cl"># created.
</span></span></code></pre></div><h5 id="4-configure-iam-permissions-of-used-gsas">4. Configure IAM permissions of used GSAs</h5>
<p>If you used <code>gcp-workload-identity-setup.sh</code> to bind Workload Identities for your cluster, you can simply add the following IAM bindings:</p>
<ul>
<li>Give GSA <code>&lt;cluster-name&gt;-kfp-system@&lt;project-id&gt;.iam.gserviceaccount.com</code> <code>Storage Object Viewer</code> role to let UI load data in GCS in the same project.</li>
<li>Give GSA <code>&lt;cluster-name&gt;-kfp-user@&lt;project-id&gt;.iam.gserviceaccount.com</code> any permissions your pipelines need. For quick tryouts, you can give it <code>Project Editor</code> role for all permissions.</li>
</ul>
<p>If you configured bindings by yourself, here are Google Cloud permission requirements for KFP KSAs:</p>
<ul>
<li>Pipelines use <code>pipeline-runner</code> KSA. Configure IAM permissions of the GSA bound to this KSA to allow pipelines use Google Cloud APIs.</li>
<li>Pipelines UI uses <code>ml-pipeline-ui</code> KSA. Pipelines Visualization Server uses <code>ml-pipeline-visualizationserver</code> KSA. If you need to view artifacts and visualizations stored in Google Cloud Storage (GCS) from pipelines UI, you should add Storage Object Viewer permission (or the minimal required permission) to their bound GSAs.</li>
</ul>
<h3 id="google-service-account-keys-stored-as-kubernetes-secrets">Google service account keys stored as Kubernetes secrets</h3>
<p>It is recommended to use Workload Identity for easier and secure management, but you can also choose to use GSA keys.</p>
<h4 id="authoring-pipelines-to-use-gsa-keys">Authoring pipelines to use GSA keys</h4>
<p>Each pipeline step describes a
container that is run independently. If you want to grant access for a single step to use
one of your service accounts, you can use
<a href="https://kubeflow-pipelines.readthedocs.io/en/stable/source/kfp.extensions.html#kfp.gcp.use_gcp_secret"><code>kfp.gcp.use_gcp_secret()</code></a>.
Examples for how to use this function can be found in the
<a href="https://github.com/kubeflow/examples/blob/871895c54402f68685c8e227c954d86a81c0575f/pipelines/mnist-pipelines/mnist_pipeline.py#L97">Kubeflow examples repo</a>.</p>
<h4 id="cluster-setup-to-use-use_gcp_secret-for-full-kubeflow">Cluster setup to use use_gcp_secret for Full Kubeflow</h4>
<p>From Kubeflow 1.1, there&rsquo;s no longer a <code>user-gcp-sa</code> secrets deployed for you. Recommend using Workload Identity instead.</p>
<p>For Kubeflow 1.0 or earlier, you don&rsquo;t need to do anything. Full Kubeflow deployment has already deployed the <code>user-gcp-sa</code> secret for you.</p>
<h4 id="cluster-setup-to-use-use_gcp_secret-for-pipelines-standalone">Cluster setup to use use_gcp_secret for Pipelines Standalone</h4>
<p>Pipelines Standalone require your manual setup for the <code>user-gcp-sa</code> secret used by <code>use_gcp_secret</code>.</p>
<p>Instructions to set up the secret:</p>
<ol>
<li>
<p>First download the GCE VM service account token (refer to <a href="https://cloud.google.com/iam/docs/creating-managing-service-account-keys#creating_service_account_keys">Google Cloud documentation</a> for more information):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gcloud iam service-accounts keys create application_default_credentials.json \
</span></span><span class="line"><span class="cl">  --iam-account [SA-NAME]@[PROJECT-ID].iam.gserviceaccount.com
</span></span></code></pre></div></li>
<li>
<p>Run:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl create secret -n [your-namespace] generic user-gcp-sa \
</span></span><span class="line"><span class="cl">  --from-file=user-gcp-sa.json=application_default_credentials.json
</span></span></code></pre></div></li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e8f58dfedb7f24d2f30aab8ff214e5d9">3 - Upgrading</h1>
    <div class="lead">How to upgrade your Kubeflow Pipelines deployment on Google Cloud</div>
	<h2 id="before-you-begin">Before you begin</h2>
<p>There are various options on how to install Kubeflow Pipelines in the <a href="https://kubeflow.org/docs/components/pipelines/installation/overview/">Installation Options for Kubeflow Pipelines</a> guide. Be aware that upgrade support and instructions will vary depending on the method you used to install Kubeflow Pipelines.</p>
<h3 id="upgrade-related-feature-matrix">Upgrade-related feature matrix</h3>
<table>
<thead>
<tr>
<th>Installation \ Features</th>
<th>In-place upgrade</th>
<th>Reinstallation on the same cluster</th>
<th>Reinstallation on a different cluster</th>
<th>User customizations across upgrades (via <a href="https://kustomize.io/">Kustomize</a>)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Standalone</td>
<td>✅</td>
<td>⚠️ Data is deleted by default.</td>
<td></td>
<td>✅</td>
</tr>
<tr>
<td><a href="https://github.com/kubeflow/pipelines/tree/sdk/release-1.8/manifests/kustomize/env/gcp">Standalone (managed storage)</a></td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>full Kubeflow (&gt;= v1.1)</td>
<td>✅</td>
<td>✅</td>
<td>Needs documentation</td>
<td>✅</td>
</tr>
<tr>
<td>full Kubeflow (&lt; v1.1)</td>
<td></td>
<td>✅</td>
<td>✅</td>
<td></td>
</tr>
<tr>
<td>AI Platform Pipelines</td>
<td></td>
<td>✅</td>
<td></td>
<td></td>
</tr>
<tr>
<td>AI Platform Pipelines (managed storage)</td>
<td></td>
<td>✅</td>
<td>✅</td>
<td></td>
</tr>
</tbody>
</table>
<p>Notes:</p>
<ul>
<li>When you deploy Kubeflow Pipelines with managed storage on Google Cloud, you pipeline&rsquo;s metadata and artifacts are stored in <a href="https://cloud.google.com/storage/docs">Cloud Storage</a> and <a href="https://cloud.google.com/sql/docs">Cloud SQL</a>. Using managed storage makes it easier to manage, back up, and restore Kubeflow Pipelines data.</li>
</ul>
<h2 id="kubeflow-pipelines-standalone">Kubeflow Pipelines Standalone</h2>
<p>Upgrade Support for Kubeflow Pipelines Standalone is in <strong>Beta</strong>.</p>
<p><a href="https://kubeflow.org/docs/components/pipelines/installation/standalone-deployment/#upgrading-kubeflow-pipelines">Upgrading Kubeflow Pipelines Standalone</a> introduces how to upgrade in-place.</p>
<h2 id="full-kubeflow">Full Kubeflow</h2>
<p>On Google Cloud, the full Kubeflow deployment follows <a href="https://googlecontainertools.github.io/kpt/guides/producer/packages/">the package pattern</a> starting from Kubeflow 1.1.</p>
<p>The package pattern enables you to upgrade the full Kubeflow in-place while keeping user customizations — refer to the <a href="../../deploy/upgrade">Upgrade Kubeflow on Google Cloud</a> documentation for instructions.</p>
<p>However, there&rsquo;s no current support to upgrade from Kubeflow 1.0 or earlier to Kubeflow 1.1 while keeping Kubeflow Pipelines data. This may change in the future, so provide your feedback in <a href="https://github.com/kubeflow/pipelines/issues/4346">kubeflow/pipelines#4346</a> on GitHub.</p>
<h2 id="ai-platform-pipelines">AI Platform Pipelines</h2>
<p>Upgrade Support for AI Platform Pipelines is in <strong>Alpha</strong>.</p>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Warning</h4>

    Kubeflow Pipelines Standalone deployments also show up in the AI Platform Pipelines dashboard, DO NOT follow instructions below if you deployed Kubeflow Pipelines using standalone deployment.
Because data is deleted by default when a Kubeflow Pipelines Standalone deployment is deleted.

</div>

<p>Below are the steps that describe how to upgrade your AI Platform Pipelines instance while keeping existing data:</p>
<h3 id="for-instances-_without_-managed-storage">For instances <em>without</em> managed storage:</h3>
<ol>
<li><a href="https://cloud.google.com/ai-platform/pipelines/docs/getting-started#clean_up">Delete your AI Platform Pipelines instance</a> <strong>WITHOUT</strong> selecting <strong>Delete cluster</strong>. The persisted artifacts and database data are stored in persistent volumes in the cluster. They are kept by default when you do not delete the cluster.</li>
<li><a href="https://console.cloud.google.com/marketplace/details/google-cloud-ai-platform/kubeflow-pipelines">Reinstall Kubeflow Pipelines from the Google Cloud Marketplace</a> using the same <strong>Google Kubernetes Engine cluster</strong>, <strong>namespace</strong>, and <strong>application name</strong>. Persisted data will be automatically picked up during reinstallation.</li>
</ol>
<h3 id="for-instances-_with_-managed-storage">For instances <em>with</em> managed storage:</h3>
<ol>
<li><a href="https://cloud.google.com/ai-platform/pipelines/docs/getting-started#clean_up">Delete your AI Platform Pipelines instance</a>.</li>
<li>If you are upgrading from Kubeflow Pipelines 0.5.1, note that the Cloud Storage bucket is a required starting from 1.0.0. Previously deployed instances should be using a bucket named like &ldquo;<cloudsql instance connection name>-<database prefix or instance name>&rdquo;. Browse <a href="https://console.cloud.google.com/storage/browser">your Cloud Storage buckets</a> to find your existing bucket name and provide it in the next step.</li>
<li><a href="https://console.cloud.google.com/marketplace/details/google-cloud-ai-platform/kubeflow-pipelines">Reinstall Kubeflow Pipelines from the Google Cloud Marketplace</a> using the same application name and managed storage options as before. You can freely install it in any cluster and namespace (not necessarily the same as before), because persisted artifacts and database data are stored in managed storages (Cloud Storage and Cloud SQL), and will be automatically picked up during reinstallation.</li>
</ol>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d79816c8e6fac2f07383ee4b56fd17de">4 - Enabling GPU and TPU</h1>
    <div class="lead">Enable GPU and TPU for Kubeflow Pipelines on Google Kubernetes Engine (GKE)</div>
	<p>This page describes how to enable GPU or TPU for a pipeline on Google Kubernetes Engine by using the Pipelines
DSL language.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>To enable GPU and TPU on your Kubeflow cluster, follow the instructions on how to
<a href="../../customizing#common-customizations">customize</a> the Google Kubernetes Engine cluster for Kubeflow before
setting up the cluster.</p>
<h2 id="configure-containerop-to-consume-gpus">Configure ContainerOp to consume GPUs</h2>
<p>After enabling the GPU, the Kubeflow setup script installs a default GPU pool with type nvidia-tesla-k80 with auto-scaling enabled.
The following code consumes 2 GPUs in a ContainerOp.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">kfp.dsl</span> <span class="k">as</span> <span class="nn">dsl</span>
</span></span><span class="line"><span class="cl"><span class="n">gpu_op</span> <span class="o">=</span> <span class="n">dsl</span><span class="o">.</span><span class="n">ContainerOp</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;gpu-op&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="n">set_gpu_limit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span></code></pre></div><p>The code above will be compiled into Kubernetes Pod spec:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">container</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nvidia.com/gpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w">
</span></span></span></code></pre></div><p>If the cluster has multiple node pools with different GPU types, you can specify the GPU type by the following code.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">kfp.dsl</span> <span class="k">as</span> <span class="nn">dsl</span>
</span></span><span class="line"><span class="cl"><span class="n">gpu_op</span> <span class="o">=</span> <span class="n">dsl</span><span class="o">.</span><span class="n">ContainerOp</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;gpu-op&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="n">set_gpu_limit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">gpu_op</span><span class="o">.</span><span class="n">add_node_selector_constraint</span><span class="p">(</span><span class="s1">&#39;cloud.google.com/gke-accelerator&#39;</span><span class="p">,</span> <span class="s1">&#39;nvidia-tesla-p4&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>The code above will be compiled into Kubernetes Pod spec:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">container</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nvidia.com/gpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud.google.com/gke-accelerator</span><span class="p">:</span><span class="w"> </span><span class="l">nvidia-tesla-p4</span><span class="w">
</span></span></span></code></pre></div><p>See <a href="https://github.com/kubeflow/pipelines/tree/sdk/release-1.8/samples/tutorials/gpu">GPU tutorial</a> for a complete example to build a Kubeflow pipeline that uses GPUs.</p>
<p>Check the <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/gpus">Google Kubernetes Engine GPU guide</a> to learn more about GPU settings.</p>
<h2 id="configure-containerop-to-consume-tpus">Configure ContainerOp to consume TPUs</h2>
<p>Use the following code to configure ContainerOp to consume TPUs on Google Kubernetes Engine:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">kfp.dsl</span> <span class="k">as</span> <span class="nn">dsl</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">kfp.gcp</span> <span class="k">as</span> <span class="nn">gcp</span>
</span></span><span class="line"><span class="cl"><span class="n">tpu_op</span> <span class="o">=</span> <span class="n">dsl</span><span class="o">.</span><span class="n">ContainerOp</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tpu-op&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">gcp</span><span class="o">.</span><span class="n">use_tpu</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">tpu_cores</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">tpu_resource</span> <span class="o">=</span> <span class="s1">&#39;v2&#39;</span><span class="p">,</span> <span class="n">tf_version</span> <span class="o">=</span> <span class="s1">&#39;1.12&#39;</span><span class="p">))</span>
</span></span></code></pre></div><p>The above code uses 8 v2 TPUs with TF version to be 1.12. The code above will be compiled into Kubernetes Pod spec:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">container</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cloud-tpus.google.com/v2</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;8&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tf-version.cloud-tpus.google.com</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1.12&#34;</span><span class="w">
</span></span></span></code></pre></div><p>To learn more, see an <a href="https://github.com/kubeflow/pipelines/blob/sdk/release-1.8/samples/core/preemptible_tpu_gpu/preemptible_tpu_gpu.py">example pipeline that uses a preemptible node pool with TPU or GPU.</a>.</p>
<p>See the <a href="https://cloud.google.com/tpu/docs/kubernetes-engine-setup">Google Kubernetes Engine TPU Guide</a> to learn more about TPU settings.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ee70eee465844b15b58f4b4844b00eab">5 - Using Preemptible VMs and GPUs on Google Cloud</h1>
    <div class="lead">Configuring preemptible VMs and GPUs for Kubeflow Pipelines on Google Cloud</div>
	<p>This document describes how to configure preemptible virtual machines
(<a href="https://cloud.google.com/kubernetes-engine/docs/how-to/preemptible-vms">preemptible VMs</a>)
and GPUs on preemptible VM instances
(<a href="https://cloud.google.com/compute/docs/instances/preemptible#preemptible_with_gpu">preemptible GPUs</a>)
for your workflows running on Kubeflow Pipelines on Google Cloud.</p>
<h2 id="introduction">Introduction</h2>
<p>Preemptible VMs are <a href="https://cloud.google.com/compute/docs/instances/">Compute Engine VM
instances</a> that last a maximum
of 24 hours and provide no availability guarantees. The
<a href="https://cloud.google.com/compute/pricing">pricing</a> of preemptible VMs is
lower than that of standard Compute Engine VMs.</p>
<p>GPUs attached to preemptible instances
(<a href="https://cloud.google.com/compute/docs/instances/preemptible#preemptible_with_gpu">preemptible GPUs</a>)
work like normal GPUs but persist only for the life of the instance.</p>
<p>Using preemptible VMs and GPUs can reduce costs on Google Cloud.
In addition to using preemptible VMs, your Google Kubernetes Engine (GKE)
cluster can autoscale based on current workloads.</p>
<p>This guide assumes that you have already deployed Kubeflow Pipelines. If not,
follow the guide to <a href="../../deploy/">deploying Kubeflow on Google Cloud</a>.</p>
<h2 id="before-you-start">Before you start</h2>
<p>The variables defined in this page can be found in <a href="https://github.com/googlecloudplatform/kubeflow-distribution/blob/master/kubeflow/env.sh">kubeflow-distribution/kubeflow/env.sh</a>. They are the same value as you set based on your <a href="../../deploy/deploy-cli/#environment-variables">Kubeflow deployment</a>.</p>
<h2 id="using-preemptible-vms-with-kubeflow-pipelines">Using preemptible VMs with Kubeflow Pipelines</h2>
<p>In summary, the steps to schedule a pipeline to run on <a href="https://cloud.google.com/compute/docs/instances/preemptible">preemptible
VMs</a> are as
follows:</p>
<ol>
<li>Create a
<a href="https://cloud.google.com/kubernetes-engine/docs/concepts/node-pools">node pool</a>
in your cluster that contains preemptible VMs.</li>
<li>Configure your pipelines to run on the preemptible VMs.</li>
</ol>
<p>The following sections contain more detail about the above steps.</p>
<h3 id="1-create-a-node-pool-with-preemptible-vms">1. Create a node pool with preemptible VMs</h3>
<p>Create a <code>preemptible-nodepool.yaml</code> as below and fulfill all placerholder content <code>KF_NAME</code>, <code>KF_PROJECT</code>, <code>LOCATION</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: container.cnrm.cloud.google.com/v1beta1
</span></span><span class="line"><span class="cl">kind: ContainerNodePool
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    kf-name: KF_NAME # kpt-set: ${name}
</span></span><span class="line"><span class="cl">  name: PREEMPTIBLE_CPU_POOL
</span></span><span class="line"><span class="cl">  namespace: KF_PROJECT # kpt-set: ${gcloud.core.project}
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  location: LOCATION # kpt-set: ${location}
</span></span><span class="line"><span class="cl">  initialNodeCount: 1
</span></span><span class="line"><span class="cl">  autoscaling:
</span></span><span class="line"><span class="cl">    minNodeCount: 0
</span></span><span class="line"><span class="cl">    maxNodeCount: 5
</span></span><span class="line"><span class="cl">  nodeConfig:
</span></span><span class="line"><span class="cl">    machineType: n1-standard-4
</span></span><span class="line"><span class="cl">    diskSizeGb: 100
</span></span><span class="line"><span class="cl">    diskType: pd-standard
</span></span><span class="line"><span class="cl">    preemptible: true
</span></span><span class="line"><span class="cl">    taint:
</span></span><span class="line"><span class="cl">    - effect: NO_SCHEDULE
</span></span><span class="line"><span class="cl">      key: preemptible
</span></span><span class="line"><span class="cl">      value: &#34;true&#34;
</span></span><span class="line"><span class="cl">    oauthScopes:
</span></span><span class="line"><span class="cl">    - &#34;https://www.googleapis.com/auth/logging.write&#34;
</span></span><span class="line"><span class="cl">    - &#34;https://www.googleapis.com/auth/monitoring&#34;
</span></span><span class="line"><span class="cl">    - &#34;https://www.googleapis.com/auth/devstorage.read_only&#34;
</span></span><span class="line"><span class="cl">    serviceAccountRef:
</span></span><span class="line"><span class="cl">      external: KF_NAME-vm@KF_PROJECT.iam.gserviceaccount.com # kpt-set: ${name}-vm@${gcloud.core.project}.iam.gserviceaccount.com
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      disable-legacy-endpoints: &#34;true&#34;
</span></span><span class="line"><span class="cl">  management:
</span></span><span class="line"><span class="cl">    autoRepair: true
</span></span><span class="line"><span class="cl">    autoUpgrade: true
</span></span><span class="line"><span class="cl">  clusterRef:
</span></span><span class="line"><span class="cl">    name: KF_NAME # kpt-set: ${name}
</span></span><span class="line"><span class="cl">    namespace: KF_PROJECT # kpt-set: ${name}
</span></span></code></pre></div><p>Where:</p>
<ul>
<li><code>PREEMPTIBLE_CPU_POOL</code> is the name of the node pool.</li>
<li><code>KF_NAME</code> is the name of the Kubeflow Google Kubernetes Engine cluster.</li>
<li><code>KF_PROJECT</code> is the name of your Kubeflow Google Cloud project.</li>
<li><code>LOCATION</code> is the region of this nodepool, for example: us-west1-b.</li>
<li><code>KF_NAME-vm@KF_PROJECT.iam.gserviceaccount.com</code> is your service account, replace the <code>KF_NAME</code> and <code>KF_PROJECT</code> using the value above  in this pattern, you can get vm service account you have already created in Kubeflow cluster deployment</li>
</ul>
<p>Apply the nodepool patch file above by running:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl --context<span class="o">=</span><span class="si">${</span><span class="nv">MGMTCTXT</span><span class="si">}</span> --namespace<span class="o">=</span><span class="si">${</span><span class="nv">KF_PROJECT</span><span class="si">}</span> apply -f &lt;path-to-nodepool-file&gt;/preemptible-nodepool.yaml
</span></span></code></pre></div><h4 id="for-kubeflow-pipelines-standalone-only">For Kubeflow Pipelines standalone only</h4>
<p>Alternatively, if you are on Kubeflow Pipelines standalone, or AI Platform Pipelines, you can run this command to create node pool:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gcloud container node-pools create PREEMPTIBLE_CPU_POOL \
</span></span><span class="line"><span class="cl">    --cluster=CLUSTER_NAME \
</span></span><span class="line"><span class="cl">      --enable-autoscaling --max-nodes=MAX_NODES --min-nodes=MIN_NODES \
</span></span><span class="line"><span class="cl">      --preemptible \
</span></span><span class="line"><span class="cl">      --node-taints=preemptible=true:NoSchedule \
</span></span><span class="line"><span class="cl">      --service-account=DEPLOYMENT_NAME-vm@PROJECT_NAME.iam.gserviceaccount.com
</span></span></code></pre></div><p>Below is an example of command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gcloud container node-pools create preemptible-cpu-pool \
</span></span><span class="line"><span class="cl">  --cluster=user-4-18 \
</span></span><span class="line"><span class="cl">    --enable-autoscaling --max-nodes=4 --min-nodes=0 \
</span></span><span class="line"><span class="cl">    --preemptible \
</span></span><span class="line"><span class="cl">    --node-taints=preemptible=true:NoSchedule \
</span></span><span class="line"><span class="cl">    --service-account=user-4-18-vm@ml-pipeline-project.iam.gserviceaccount.com
</span></span></code></pre></div><h3 id="2-schedule-your-pipeline-to-run-on-the-preemptible-vms">2. Schedule your pipeline to run on the preemptible VMs</h3>
<p>After configuring a node pool with preemptible VMs, you must configure your
pipelines to run on the preemptible VMs.</p>
<p>In the DSL code for
your pipeline, add the following to the <code>ContainerOp</code> instance:</p>
<pre><code>.apply(gcp.use_preemptible_nodepool())
</code></pre>
<p>The above function works for both methods of generating the <code>ContainerOp</code>:</p>
<ul>
<li>The <code>ContainerOp</code> generated from
<a href="https://github.com/kubeflow/pipelines/blob/sdk/release-1.8/sdk/python/kfp/components/_python_op.py"><code>kfp.components.func_to_container_op</code></a>.</li>
<li>The <code>ContainerOp</code> generated from the task factory function, which is
loaded by <a href="https://github.com/kubeflow/pipelines/blob/sdk/release-1.8/sdk/python/kfp/components/_components.py"><code>components.load_component_from_url</code></a>.</li>
</ul>
<p><strong>Note</strong>:</p>
<ul>
<li>Call <code>.set_retry(#NUM_RETRY)</code> on your <code>ContainerOp</code> to retry
the task after the task is preempted.</li>
<li>If you modified the
<a href="https://cloud.google.com/kubernetes-engine/docs/how-to/node-taints">node taint</a>
when creating the node pool, pass the same node toleration to the
<code>use_preemptible_nodepool()</code> function.</li>
<li><code>use_preemptible_nodepool()</code> also accepts a parameter <code>hard_constraint</code>. When the <code>hard_constraint</code> is
<code>True</code>, the system will strictly schedule the task in preemptible VMs. When the <code>hard_constraint</code> is
<code>False</code>, the system will try to schedule the task in preemptible VMs. If it cannot find the preemptible VMs,
or the preemptible VMs are busy, the system will schedule the task in normal VMs.</li>
</ul>
<p>For example:</p>
<pre><code>import kfp.dsl as dsl
import kfp.gcp as gcp

class FlipCoinOp(dsl.ContainerOp):
  &quot;&quot;&quot;Flip a coin and output heads or tails randomly.&quot;&quot;&quot;

  def __init__(self):
    super(FlipCoinOp, self).__init__(
      name='Flip',
      image='python:alpine3.6',
      command=['sh', '-c'],
      arguments=['python -c &quot;import random; result = \'heads\' if random.randint(0,1) == 0 '
                 'else \'tails\'; print(result)&quot; | tee /tmp/output'],
      file_outputs={'output': '/tmp/output'})

@dsl.pipeline(
  name='pipeline flip coin',
  description='shows how to use dsl.Condition.'
)

def flipcoin():
  flip = FlipCoinOp().apply(gcp.use_preemptible_nodepool())

if __name__ == '__main__':
  import kfp.compiler as compiler
  compiler.Compiler().compile(flipcoin, __file__ + '.zip')
</code></pre>
<h2 id="using-preemptible-gpus-with-kubeflow-pipelines">Using preemptible GPUs with Kubeflow Pipelines</h2>
<p>This guide assumes that you have already deployed Kubeflow Pipelines. In
summary, the steps to schedule a pipeline to run with
<a href="https://cloud.google.com/compute/docs/instances/preemptible#preemptible_with_gpu">preemptible GPUs</a>
are as follows:</p>
<ol>
<li>Make sure you have enough GPU quota.</li>
<li>Create a node pool in your Google Kubernetes Engine cluster that contains preemptible VMs with
preemptible GPUs.</li>
<li>Configure your pipelines to run on the preemptible VMs with preemptible
GPUs.</li>
</ol>
<p>The following sections contain more detail about the above steps.</p>
<h3 id="1-make-sure-you-have-enough-gpu-quota">1. Make sure you have enough GPU quota</h3>
<p>Add GPU quota to your Google Cloud project. The <a href="https://cloud.google.com/compute/docs/gpus/#introduction">Google Cloud
documentation</a> lists
the availability of GPUs across regions. To check the available quota for
resources in your project, go to the
<a href="https://console.cloud.google.com/iam-admin/quotas">Quotas</a> page in the Google Cloud
Console.</p>
<h3 id="2-create-a-node-pool-of-preemptible-vms-with-preemptible-gpus">2. Create a node pool of preemptible VMs with preemptible GPUs</h3>
<p>Create a <code>preemptible-gpu-nodepool.yaml</code> as below and fulfill all placerholder content:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: container.cnrm.cloud.google.com/v1beta1
</span></span><span class="line"><span class="cl">kind: ContainerNodePool
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    kf-name: KF_NAME # kpt-set: ${name}
</span></span><span class="line"><span class="cl">  name: KF_NAME-containernodepool-gpu
</span></span><span class="line"><span class="cl">  namespace: KF_PROJECT # kpt-set: ${gcloud.core.project}
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  location: LOCATION # kpt-set: ${location}
</span></span><span class="line"><span class="cl">  initialNodeCount: 1
</span></span><span class="line"><span class="cl">  autoscaling:
</span></span><span class="line"><span class="cl">    minNodeCount: 0
</span></span><span class="line"><span class="cl">    maxNodeCount: 5
</span></span><span class="line"><span class="cl">  nodeConfig:
</span></span><span class="line"><span class="cl">    machineType: n1-standard-4
</span></span><span class="line"><span class="cl">    diskSizeGb: 100
</span></span><span class="line"><span class="cl">    diskType: pd-standard
</span></span><span class="line"><span class="cl">    preemptible: true
</span></span><span class="line"><span class="cl">    oauthScopes:
</span></span><span class="line"><span class="cl">    - &#34;https://www.googleapis.com/auth/logging.write&#34;
</span></span><span class="line"><span class="cl">    - &#34;https://www.googleapis.com/auth/monitoring&#34;
</span></span><span class="line"><span class="cl">    - &#34;https://www.googleapis.com/auth/devstorage.read_only&#34;
</span></span><span class="line"><span class="cl">    serviceAccountRef:
</span></span><span class="line"><span class="cl">      external: KF_NAME-vm@KF_PROJECT.iam.gserviceaccount.com # kpt-set: ${name}-vm@${gcloud.core.project}.iam.gserviceaccount.com
</span></span><span class="line"><span class="cl">    guestAccelerator:
</span></span><span class="line"><span class="cl">    - type: &#34;nvidia-tesla-k80&#34;
</span></span><span class="line"><span class="cl">      count: 1
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      disable-legacy-endpoints: &#34;true&#34;
</span></span><span class="line"><span class="cl">  management:
</span></span><span class="line"><span class="cl">    autoRepair: true
</span></span><span class="line"><span class="cl">    autoUpgrade: true
</span></span><span class="line"><span class="cl">  clusterRef:
</span></span><span class="line"><span class="cl">    name: KF_NAME # kpt-set: ${name}
</span></span><span class="line"><span class="cl">    namespace: KF_PROJECT # kpt-set: ${gcloud.core.project}
</span></span></code></pre></div><p>Where:</p>
<ul>
<li><code>PREEMPTIBLE_CPU_POOL</code> is the name of the node pool.</li>
<li><code>KF_NAME</code> is the name of the Kubeflow Google Kubernetes Engine cluster.</li>
<li><code>KF_PROJECT</code> is the name of your Kubeflow Google Cloud project.</li>
<li><code>LOCATION</code> is the region of this nodepool, for example: us-west1-b.</li>
<li><code>KF_NAME-vm@KF_PROJECT.iam.gserviceaccount.com</code> is your service account, replace the <code>KF_NAME</code> and <code>KF_PROJECT</code> using the value above  in this pattern, you can get vm service account you have already created in Kubeflow cluster deployment.</li>
</ul>
<h4 id="for-kubeflow-pipelines-standalone-only-1">For Kubeflow Pipelines standalone only</h4>
<p>Alternatively, if you are on Kubeflow Pipelines standalone, or AI Platform Pipelines, you can run this command to create node pool:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gcloud container node-pools create PREEMPTIBLE_GPU_POOL \
</span></span><span class="line"><span class="cl">    --cluster=CLUSTER_NAME \
</span></span><span class="line"><span class="cl">    --enable-autoscaling --max-nodes=MAX_NODES --min-nodes=MIN_NODES \
</span></span><span class="line"><span class="cl">    --preemptible \
</span></span><span class="line"><span class="cl">    --node-taints=preemptible=true:NoSchedule \
</span></span><span class="line"><span class="cl">    --service-account=DEPLOYMENT_NAME-vm@PROJECT_NAME.iam.gserviceaccount.com \
</span></span><span class="line"><span class="cl">    --accelerator=type=GPU_TYPE,count=GPU_COUNT
</span></span></code></pre></div><p>Below is an example of command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">gcloud container node-pools create preemptible-gpu-pool \
</span></span><span class="line"><span class="cl">    --cluster=user-4-18 \
</span></span><span class="line"><span class="cl">    --enable-autoscaling --max-nodes=4 --min-nodes=0 \
</span></span><span class="line"><span class="cl">    --preemptible \
</span></span><span class="line"><span class="cl">    --node-taints=preemptible=true:NoSchedule \
</span></span><span class="line"><span class="cl">    --service-account=user-4-18-vm@ml-pipeline-project.iam.gserviceaccount.com \
</span></span><span class="line"><span class="cl">    --accelerator=type=nvidia-tesla-t4,count=2
</span></span></code></pre></div><h3 id="3-schedule-your-pipeline-to-run-on-the-preemptible-vms-with-preemptible-gpus">3. Schedule your pipeline to run on the preemptible VMs with preemptible GPUs</h3>
<p>In the <a href="https://www.kubeflow.org/docs/components/pipelines/sdk/build-pipeline/">DSL code</a> for
your pipeline, add the following to the <code>ContainerOp</code> instance:</p>
<pre><code>.apply(gcp.use_preemptible_nodepool()
</code></pre>
<p>The above function works for both methods of generating the <code>ContainerOp</code>:</p>
<ul>
<li>The <code>ContainerOp</code> generated from
<a href="https://github.com/kubeflow/pipelines/blob/sdk/release-1.8/sdk/python/kfp/components/_python_op.py"><code>kfp.components.func_to_container_op</code></a>.</li>
<li>The <code>ContainerOp</code> generated from the task factory function, which is
loaded by <a href="https://github.com/kubeflow/pipelines/blob/sdk/release-1.8/sdk/python/kfp/components/_components.py"><code>components.load_component_from_url</code></a>.</li>
</ul>
<p><strong>Note</strong>:</p>
<ul>
<li>Call <code>.set_gpu_limit(#NUM_GPUs, GPU_VENDOR)</code> on your
<code>ContainerOp</code> to specify the GPU limit (for example, <code>1</code>) and vendor (for
example, <code>'nvidia'</code>).</li>
<li>Call <code>.set_retry(#NUM_RETRY)</code> on your <code>ContainerOp</code> to retry
the task after the task is preempted.</li>
<li>If you modified the
<a href="https://cloud.google.com/kubernetes-engine/docs/how-to/node-taints">node taint</a>
when creating the node pool, pass the same node toleration to the
<code>use_preemptible_nodepool()</code> function.</li>
<li><code>use_preemptible_nodepool()</code> also accepts a parameter <code>hard_constraint</code>. When the <code>hard_constraint</code> is
<code>True</code>, the system will strictly schedule the task in preemptible VMs. When the <code>hard_constraint</code> is
<code>False</code>, the system will try to schedule the task in preemptible VMs. If it cannot find the preemptible VMs,
or the preemptible VMs are busy, the system will schedule the task in normal VMs.</li>
</ul>
<p>For example:</p>
<pre><code>import kfp.dsl as dsl
import kfp.gcp as gcp

class FlipCoinOp(dsl.ContainerOp):
  &quot;&quot;&quot;Flip a coin and output heads or tails randomly.&quot;&quot;&quot;

  def __init__(self):
    super(FlipCoinOp, self).__init__(
      name='Flip',
      image='python:alpine3.6',
      command=['sh', '-c'],
      arguments=['python -c &quot;import random; result = \'heads\' if random.randint(0,1) == 0 '
                 'else \'tails\'; print(result)&quot; | tee /tmp/output'],
      file_outputs={'output': '/tmp/output'})

@dsl.pipeline(
  name='pipeline flip coin',
  description='shows how to use dsl.Condition.'
)

def flipcoin():
  flip = FlipCoinOp().set_gpu_limit(1, 'nvidia').apply(gcp.use_preemptible_nodepool())
if __name__ == '__main__':
  import kfp.compiler as compiler
  compiler.Compiler().compile(flipcoin, __file__ + '.zip')
</code></pre>
<h2 id="debugging">Debugging</h2>
<p>Run the following command if your nodepool didn&rsquo;t show up or has error during provisioning:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl --context<span class="o">=</span><span class="si">${</span><span class="nv">MGMTCTXT</span><span class="si">}</span> --namespace<span class="o">=</span><span class="si">${</span><span class="nv">KF_PROJECT</span><span class="si">}</span> describe containernodepool -l kf-name<span class="o">=</span><span class="si">${</span><span class="nv">KF_NAME</span><span class="si">}</span>
</span></span></code></pre></div><h2 id="next-steps">Next steps</h2>
<ul>
<li>Explore further options for <a href="../../">customizing Kubeflow on Google Cloud</a>.</li>
<li>See how to <a href="https://kubeflow.org/docs/components/pipelines/sdk/build-pipeline/">build pipelines with the SDK</a>.</li>
</ul>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark pt-3 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Kubeflow mailing list" aria-label="Kubeflow mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://www.kubeflow.org/docs/about/community/#kubeflow-mailing-list" aria-label="Kubeflow mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://www.kubeflow.org/docs/about/community/#kubeflow-slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://twitter.com/kubeflow" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://stackoverflow.com/questions/tagged/kubeflow" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2023 The Kubeflow Authors. | Documentation Distributed under CC BY 4.0</small>
        <p><small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">Privacy Policy</a></small></p>
	
		
	
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/googlecloudplatform/kubeflow-distribution" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Kubeflow community calendar" aria-label="Kubeflow community calendar">
    <a class="text-white" target="_blank" rel="noopener" href="https://www.kubeflow.org/docs/about/community/#kubeflow-community-calendars" aria-label="Kubeflow community calendar">
      <i class="fa fa-calendar"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="/kubeflow-gke-docs/dev/js/main.min.540ec1b72bead82cdc6abc13982a46cdc63ebeadb6d74fdb7a408a5424892f20.js" integrity="sha256-VA7Btyvq2CzcarwTmCpGzcY&#43;vq2210/bekCKVCSJLyA=" crossorigin="anonymous"></script>
<script src='/kubeflow-gke-docs/dev/js/tabpane-persist.js'></script>

  </body>
</html>
