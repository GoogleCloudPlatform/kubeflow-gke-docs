<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.105.0">
<link rel="canonical" type="text/html" href="https://gkcalat.github.io/kubeflow-docs/docs/components/training/">
<link rel="alternate" type="application/rss&#43;xml" href="https://gkcalat.github.io/kubeflow-docs/docs/components/training/index.xml">
<meta name="robots" content="noindex, nofollow">

<script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "WebSite",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https:\/\/gkcalat.github.io\/kubeflow-docs"
      },
      "articleSection" : "docs",
      "name" : "Training Operators",
      "headline" : "Training Operators",
      "description" : "Training of ML models in Kubeflow through operators",
      "inLanguage" : "en-US",
      "author" : "",
      "creator" : "",
      "publisher": "",
      "accountablePerson" : "",
      "copyrightHolder" : "",
      "copyrightYear" : "0001",
      "datePublished": "0001-01-01 00:00:00 \u002b0000 UTC",
      "dateModified" : "0001-01-01 00:00:00 \u002b0000 UTC",
      "url" : "https:\/\/gkcalat.github.io\/kubeflow-docs\/docs\/components\/training\/",
      "wordCount" : "0",
      "keywords" : [ "Kubeflow" ]
  }
  </script>

<link rel="shortcut icon" href="/kubeflow-docs/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/kubeflow-docs/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/kubeflow-docs/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/kubeflow-docs/favicons/favicon-32x32.png" sizes="32x32">
<link rel="manifest" href="/kubeflow-docs/favicons/manifest.json">
<meta name="msapplication-config" content="/kubeflow-docs/favicons/browserconfig.xml" />
<meta name="msapplication-TileColor" content="#4279f4">
<meta name="theme-color" content="#4279f4">

<title>Training Operators | Kubeflow on Google Cloud Platform</title>
<meta name="description" content="Training of ML models in Kubeflow through operators">
<meta property="og:title" content="Training Operators" />
<meta property="og:description" content="Training of ML models in Kubeflow through operators" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://gkcalat.github.io/kubeflow-docs/docs/components/training/" /><meta property="og:site_name" content="Kubeflow on Google Cloud Platform" />

<meta itemprop="name" content="Training Operators">
<meta itemprop="description" content="Training of ML models in Kubeflow through operators"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Training Operators"/>
<meta name="twitter:description" content="Training of ML models in Kubeflow through operators"/>




<link rel="preload" href="/kubeflow-docs/scss/main.min.5006b434b14f73c3d5537a7ba4c8ecef723ddc93f3a3c8530e19d24f75486ea9.css" as="style">
<link href="/kubeflow-docs/scss/main.min.5006b434b14f73c3d5537a7ba4c8ecef723ddc93f3a3c8530e19d24f75486ea9.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-GK9XL47N6S"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GK9XL47N6S', { 'anonymize_ip': false });
}
</script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand-md navbar-dark  td-navbar">
        <a class="navbar-brand" href="/kubeflow-docs/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 276.93 274.55"><g data-name="Layer 2"><g data-name="Layer 1"><path d="M95.9 62.15l4.1 102.1 73.75-94.12a6.79 6.79.0 019.6-1.11l46 36.92-15-65.61z" fill="#4279f4"/><path fill="#0028aa" d="M102.55 182.98h65.42l-40.17-32.23-25.25 32.23z"/><path fill="#014bd1" d="M180.18 83.92l-44 56.14 46.88 37.61 44.47-55.76-47.35-37.99z"/><path fill="#bedcff" d="M83.56 52.3l.01-.01 38.69-48.52-62.39 30.05-15.41 67.51 39.1-49.03z"/><path fill="#6ca1ff" d="M45.32 122.05l41.44 51.96-3.95-98.98-37.49 47.02z"/><path fill="#a1c3ff" d="M202.31 28.73 142.65.0l-37.13 46.56 96.79-17.83z"/><path d="M1.6 272v-44.78h5.74v23.41l20.48-23.41h6.4l-17.39 19.7 19 25.07H29.1l-15.92-20.8-5.84 6.65V272zm40.02-9.79V240h5.43v22.39a4.67 4.67.0 002.35 4.19 11 11 0 0011 0 4.69 4.69.0 002.33-4.19V240h5.43v22.19a9.08 9.08.0 01-4.1 7.87 16.2 16.2.0 01-18.37.0 9.07 9.07.0 01-4.07-7.85zM77.46 272v-48h5.43v16.81a29.29 29.29.0 019.32-1.73 13.1 13.1.0 016.2 1.41 10.71 10.71.0 014.18 3.74 18.07 18.07.0 012.23 5.06 21.26 21.26.0 01.73 5.58q0 8.43-4.38 12.79T87.35 272zm5.43-4.87h4.55q6.77.0 9.72-2.95t3-9.51a14.21 14.21.0 00-2-7.52 6.55 6.55.0 00-6-3.22 24.73 24.73.0 00-9.25 1.54zm29.47-11.19q0-7.71 4.09-12.3a13.75 13.75.0 0110.8-4.59q13.35.0 13.36 18.86h-22.82a12.3 12.3.0 002.9 7.07q2.59 3.11 7.9 3.1a24.92 24.92.0 0010.55-2v5a27.74 27.74.0 01-9.86 1.87 19.83 19.83.0 01-7.7-1.37 13.31 13.31.0 01-5.28-3.76 16.21 16.21.0 01-3-5.38 20.84 20.84.0 01-.94-6.5zm5.62-2.12h17.26a14.91 14.91.0 00-2.37-7.12 6.44 6.44.0 00-5.62-2.78 8.2 8.2.0 00-6.21 2.72 12.07 12.07.0 00-3.04 7.18z" fill="#4279f4" stroke="#4279f4" stroke-miterlimit="10" stroke-width="3.2"/><path d="M147.32 244.89V240h5v-7.59a8.14 8.14.0 012.31-6.05 7.79 7.79.0 015.69-2.28h7.86V229h-5c-2.21.0-3.67.45-4.37 1.34s-1.06 2.55-1.06 5V240h8.46v4.87h-8.46V272h-5.44v-27.1zM175.26 272v-48h5.43v48zm19.15-3.95a17.86 17.86.0 1112.33 4.9 16.57 16.57.0 01-12.33-4.9zm3.84-20.65a13.16 13.16.0 000 17.2 12.07 12.07.0 0017 0 13.09 13.09.0 000-17.2 12.07 12.07.0 00-17 0zm30.2-7.4h5.75l7.3 25.32 7.43-25.32h5.36l7.34 25.34L269 240h5.74l-10.04 32h-6.12l-6.83-24.58L245 272h-6.47z" fill="#0028aa" stroke="#0028aa" stroke-miterlimit="10" stroke-width="3.2"/></g></g></svg></span><span class="text-uppercase font-weight-bold">Kubeflow on Google Cloud Platform</span>
	</a>
	<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main_navbar" aria-controls="main_navbar" aria-expanded="false" aria-label="Toggle navigation">
		<span class="navbar-toggler-icon"></span>
	</button>
	<div class="collapse navbar-collapse ml-md-auto" id="main_navbar">
		<ul class="navbar-nav ml-auto pt-4 pt-md-0 my-2 my-md-1">
			
			
			<li class="nav-item mr-2 mr-lg-4 mt-1 mt-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/kubeflow-docs/docs/" ><span>Docs</span></a>
			</li>
			
			<li class="nav-item mr-2 mr-lg-4 mt-1 mt-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/kubeflow-docs/news/" ><span>News</span></a>
			</li>
			
			<li class="nav-item mr-2 mr-lg-4 mt-1 mt-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="https://github.com/GoogleCloudPlatform/kubeflow-distribution" target="_blank" ><i class='fa-brands fa-github pr-2'></i><span>Source</span></a>
			</li>
			
			
			<li class="nav-item dropdown mt-1 mt-lg-0 mr-2">
				<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	Releases
</a>
<div class="dropdown-menu dropdown-menu-md-right dropdown-menu-lg-left" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="https://gkcalat.github.io/kubeflow-docs/v1.6-release/docs">latest</a>
	
	<a class="dropdown-item" href="https://gkcalat.github.io/kubeflow-docs/v1.6-release/docs">v1.6</a>
	
	<a class="dropdown-item" href="https://gkcalat.github.io/kubeflow-docs/v1.5-release/docs">v1.5</a>
	
	<a class="dropdown-item" href="https://gkcalat.github.io/kubeflow-docs/v1.4-release/docs">v1.4</a>
	
	<a class="dropdown-item" href="https://gkcalat.github.io/kubeflow-docs/main/docs">dev</a>
	
</div>

			</li>
			
			
		</ul>
	</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/kubeflow-docs/docs/components/training/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Training Operators</h1>
<div class="lead">Training of ML models in Kubeflow through operators</div>




    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-576bf8908783688384260fc466c40af5">TensorFlow Training (TFJob)</a></li>


    
  
    
    
	
<li>2: <a href="#pg-94aec72d7979152842ed2f8cbe6dbe06">PyTorch Training (PyTorchJob)</a></li>


    
  
    
    
	
<li>3: <a href="#pg-918c00c4648652b4a145759ea270e3fe">MXNet Training (MXJob)</a></li>


    
  
    
    
	
<li>4: <a href="#pg-66d70221609b85eb891d6f7d3b11fbe6">XGBoost Training (XGBoostJob)</a></li>


    
  
    
    
	
<li>5: <a href="#pg-e31f8fe300fca877319ecc67f6f703f2">MPI Training (MPIJob)</a></li>


    
  
    
    
	
<li>6: <a href="#pg-0f6575cd7361e2994f36778f82849b99">Job Scheduling</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-576bf8908783688384260fc466c40af5">1 - TensorFlow Training (TFJob)</h1>
    <div class="lead">Using TFJob to train a model with TensorFlow</div>
	<div class="alert alert-primary" role="alert">
This Kubeflow component has <b>stable</b> status. See the
<a href="/docs/started/support/#application-status">Kubeflow versioning policies</a>.
</div>
<p>This page describes <code>TFJob</code> for training a machine learning model with <a href="https://www.tensorflow.org/">TensorFlow</a>.</p>
<h2 id="what-is-tfjob">What is TFJob?</h2>
<p><code>TFJob</code> is a Kubernetes
<a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">custom resource</a>
to run TensorFlow training jobs on Kubernetes. The Kubeflow implementation of
<code>TFJob</code> is in <a href="https://github.com/kubeflow/training-operator"><code>training-operator</code></a>.</p>
<p><strong>Note</strong>: <code>TFJob</code> doesn&rsquo;t work in a user namespace by default because of Istio <a href="https://istio.io/v1.3/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection">automatic sidecar injection</a>. In order to get <code>TFJob</code> running, it needs annotation <code>sidecar.istio.io/inject: &quot;false&quot;</code> to disable it for <code>TFJob</code> pods.</p>
<p>A <code>TFJob</code> is a resource with a YAML representation like the one below (edit to use the container image and command for your own training code):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeflow.org/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">TFJob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generateName</span><span class="p">:</span><span class="w"> </span><span class="l">tfjob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">your-user-namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tfReplicaSpecs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">PS</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">sidecar.istio.io/inject</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tensorflow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.io/your-project/your-image</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">python</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- -<span class="l">m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">trainer.task</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">batch_size=32</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">training_steps=1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Worker</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">sidecar.istio.io/inject</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tensorflow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.io/your-project/your-image</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">python</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- -<span class="l">m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">trainer.task</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">batch_size=32</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">training_steps=1000</span><span class="w">
</span></span></span></code></pre></div><p>If you want to give your <code>TFJob</code> pods access to credentials secrets, such as the GCP credentials automatically created when you do a GKE-based Kubeflow installation, you can mount and use a secret like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeflow.org/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">TFJob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generateName</span><span class="p">:</span><span class="w"> </span><span class="l">tfjob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">your-user-namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tfReplicaSpecs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">PS</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">sidecar.istio.io/inject</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tensorflow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.io/your-project/your-image</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">python</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- -<span class="l">m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">trainer.task</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">batch_size=32</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">training_steps=1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">GOOGLE_APPLICATION_CREDENTIALS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/secrets/user-gcp-sa.json&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sa</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/secrets&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sa</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">user-gcp-sa</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Worker</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">sidecar.istio.io/inject</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tensorflow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.io/your-project/your-image</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">python</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- -<span class="l">m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">trainer.task</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">batch_size=32</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">training_steps=1000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">GOOGLE_APPLICATION_CREDENTIALS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/secrets/user-gcp-sa.json&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sa</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/etc/secrets&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sa</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">user-gcp-sa</span><span class="w">
</span></span></span></code></pre></div><p>If you are not familiar with Kubernetes resources please refer to the page <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/kubernetes-objects/">Understanding Kubernetes Objects</a>.</p>
<p>What makes <code>TFJob</code> different from built in <a href="https://kubernetes.io/docs/concepts/workloads/controllers/">controllers</a> is the <code>TFJob</code> spec is designed to manage
<a href="https://www.tensorflow.org/guide/distributed_training">distributed TensorFlow training jobs</a>.</p>
<p>A distributed TensorFlow job typically contains 0 or more of the following processes</p>
<ul>
<li><strong>Chief</strong> The chief is responsible for orchestrating training and performing tasks
like checkpointing the model.</li>
<li><strong>Ps</strong> The ps are parameter servers; these servers provide a distributed data store
for the model parameters.</li>
<li><strong>Worker</strong> The workers do the actual work of training the model. In some cases,
worker 0 might also act as the chief.</li>
<li><strong>Evaluator</strong> The evaluators can be used to compute evaluation metrics as the model
is trained.</li>
</ul>
<p>The field <strong>tfReplicaSpecs</strong> in <code>TFJob</code> spec contains a map from the type of
replica (as listed above) to the <strong>TFReplicaSpec</strong> for that replica. <strong>TFReplicaSpec</strong>
consists of 3 fields</p>
<ul>
<li>
<p><strong>replicas</strong> The number of replicas of this type to spawn for this <code>TFJob</code>.</p>
</li>
<li>
<p><strong>template</strong> A <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#podtemplatespec-v1-core">PodTemplateSpec</a> that describes the pod to create
for each replica.</p>
<ul>
<li><strong>The pod must include a container named <code>tensorflow</code></strong>.</li>
</ul>
</li>
<li>
<p><strong>restartPolicy</strong> Determines whether pods will be restarted when they exit. The
allowed values are as follows</p>
<ul>
<li>
<p><strong>Always</strong> means the pod will always be restarted. This policy is good
for parameter servers since they never exit and should always be restarted
in the event of failure.</p>
</li>
<li>
<p><strong>OnFailure</strong> means the pod will be restarted if the pod exits due to failure.</p>
<ul>
<li>A non-zero exit code indicates a failure.</li>
<li>An exit code of 0 indicates success and the pod will not be restarted.</li>
<li>This policy is good for chief and workers.</li>
</ul>
</li>
<li>
<p><strong>ExitCode</strong> means the restart behavior is dependent on the exit code of
the <code>tensorflow</code> container as follows:</p>
<ul>
<li>
<p>Exit code <code>0</code> indicates the process completed successfully and will
not be restarted.</p>
</li>
<li>
<p>The following exit codes indicate a permanent error and the container
will not be restarted:</p>
<ul>
<li><code>1</code>: general errors</li>
<li><code>2</code>: misuse of shell builtins</li>
<li><code>126</code>: command invoked cannot execute</li>
<li><code>127</code>: command not found</li>
<li><code>128</code>: invalid argument to exit</li>
<li><code>139</code>: container terminated by SIGSEGV (invalid memory reference)</li>
</ul>
</li>
<li>
<p>The following exit codes indicate a retryable error and the container
will be restarted:</p>
<ul>
<li><code>130</code>: container terminated by SIGINT (keyboard Control-C)</li>
<li><code>137</code>: container received a SIGKILL</li>
<li><code>143</code>: container received a SIGTERM</li>
</ul>
</li>
<li>
<p>Exit code <code>138</code> corresponds to SIGUSR1 and is reserved for
user-specified retryable errors.</p>
</li>
<li>
<p>Other exit codes are undefined and there is no guarantee about the
behavior.</p>
</li>
</ul>
<p>For background information on exit codes, see the <a href="https://www.gnu.org/software/libc/manual/html_node/Termination-Signals.html">GNU guide to
termination signals</a>
and the <a href="http://tldp.org/LDP/abs/html/exitcodes.html">Linux Documentation
Project</a>.</p>
</li>
<li>
<p><strong>Never</strong> means pods that terminate will never be restarted. This policy
should rarely be used because Kubernetes will terminate pods for any number
of reasons (e.g. node becomes unhealthy) and this will prevent the job from
recovering.</p>
</li>
</ul>
</li>
</ul>
<h2 id="installing-tensorflow-operator">Installing TensorFlow Operator</h2>
<p>If you haven&rsquo;t already done so please follow the <a href="/docs/started/getting-started/">Getting Started Guide</a> to deploy Kubeflow.</p>
<blockquote>
<p>By default, <code>TFJob</code> Operator will be deployed as a controller in training operator.</p>
</blockquote>
<p>If you want to install a standalone version of the training operator without Kubeflow,
see the <a href="https://github.com/kubeflow/training-operator#installation">kubeflow/training-operator&rsquo;s README</a>.</p>
<h3 id="verify-that-tfjob-support-is-included-in-your-kubeflow-deployment">Verify that TFJob support is included in your Kubeflow deployment</h3>
<p>Check that the TensorFlow custom resource is installed:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl get crd
</span></span></code></pre></div><p>The output should include <code>tfjobs.kubeflow.org</code> like the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">NAME                                             CREATED AT
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">tfjobs.kubeflow.org                         2021-09-06T18:33:58Z
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>Check that the Training operator is running via:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl get pods -n kubeflow
</span></span></code></pre></div><p>The output should include <code>training-operaror-xxx</code> like the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">NAME                                READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">training-operator-d466b46bc-xbqvs   1/1     Running   0          4m37s
</span></span></code></pre></div><h2 id="running-the-mnist-example">Running the Mnist example</h2>
<p>See the manifests for the <a href="https://github.com/kubeflow/training-operator/blob/master/examples/tensorflow/simple.yaml">distributed MNIST example</a>. You may change the config file based on your requirements.</p>
<p>Deploy the <code>TFJob</code> resource to start training:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl create -f https://raw.githubusercontent.com/kubeflow/training-operator/master/examples/tensorflow/simple.yaml
</span></span></code></pre></div><p>Monitor the job (see the <a href="#monitoring-your-job">detailed guide below</a>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl -n kubeflow get tfjob tfjob-simple -o yaml
</span></span></code></pre></div><p>Delete it</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl -n kubeflow delete tfjob tfjob-simple
</span></span></code></pre></div><h2 id="customizing-the-tfjob">Customizing the TFJob</h2>
<p>Typically you can change the following values in the <code>TFJob</code> yaml file:</p>
<ol>
<li>
<p>Change the image to point to the docker image containing your code</p>
</li>
<li>
<p>Change the number and types of replicas</p>
</li>
<li>
<p>Change the resources (requests and limits) assigned to each resource</p>
</li>
<li>
<p>Set any environment variables</p>
<ul>
<li>For example, you might need to configure various environment variables to talk to datastores like GCS or S3</li>
</ul>
</li>
<li>
<p>Attach PVs if you want to use PVs for storage.</p>
</li>
</ol>
<h2 id="using-gpus">Using GPUs</h2>
<p>To use GPUs your cluster must be configured to use GPUs.</p>
<ul>
<li>Nodes must have GPUs attached.</li>
<li>The Kubernetes cluster must recognize the <code>nvidia.com/gpu</code> resource type.</li>
<li>GPU drivers must be installed on the cluster.</li>
<li>For more information:
<ul>
<li><a href="https://kubernetes.io/docs/tasks/manage-gpus/scheduling-gpus/">Kubernetes instructions for scheduling GPUs</a></li>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/concepts/gpus">GKE instructions</a></li>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/gpu-ami.html">EKS instructions</a></li>
</ul>
</li>
</ul>
<p>To attach GPUs specify the GPU resource on the container in the replicas
that should contain the GPUs; for example.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;kubeflow.org/v1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;TFJob&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;tf-smoke-gpu&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tfReplicaSpecs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">PS</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">python</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">tf_cnn_benchmarks.py</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">batch_size=32</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">model=resnet50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">variable_update=parameter_server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">flush_stdout=true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">num_gpus=1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">local_parameter_device=cpu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">device=cpu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">data_format=NHWC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.io/kubeflow/tf-benchmarks-cpu:v20171202-bdab599-dirty-284af3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tensorflow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">2222</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tfjob-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">workingDir</span><span class="p">:</span><span class="w"> </span><span class="l">/opt/tf-benchmarks/scripts/tf_cnn_benchmarks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Worker</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">python</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">tf_cnn_benchmarks.py</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">batch_size=32</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">model=resnet50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">variable_update=parameter_server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">flush_stdout=true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">num_gpus=1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">local_parameter_device=cpu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">device=gpu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">data_format=NHWC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.io/kubeflow/tf-benchmarks-gpu:v20171202-bdab599-dirty-284af3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tensorflow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">2222</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tfjob-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">nvidia.com/gpu</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">workingDir</span><span class="p">:</span><span class="w"> </span><span class="l">/opt/tf-benchmarks/scripts/tf_cnn_benchmarks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></span></span></code></pre></div><p>Follow TensorFlow&rsquo;s <a href="https://www.tensorflow.org/guide/gpu">instructions</a>
for using GPUs.</p>
<h2 id="monitoring-your-job">Monitoring your job</h2>
<p>To get the status of your job</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl -n kubeflow get -o yaml tfjobs tfjob-simple
</span></span></code></pre></div><p>Here is sample output for an example job</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeflow.org/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">TFJob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2021-09-06T11:48:09Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tfjob-simple</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kubeflow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;5764004&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selfLink</span><span class="p">:</span><span class="w"> </span><span class="l">/apis/kubeflow.org/v1/namespaces/kubeflow/tfjobs/tfjob-simple</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">3a67a9a9-cb89-4c1f-a189-f49f0b581e29</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tfReplicaSpecs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Worker</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">python</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">/var/tf_mnist/mnist_with_summaries.py</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.io/kubeflow-ci/tf-mnist-with-summaries:1.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tensorflow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">completionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2021-09-06T11:49:30Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2021-09-06T11:48:09Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lastUpdateTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2021-09-06T11:48:09Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">TFJob tfjob-simple is created.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l">TFJobCreated</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Created</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2021-09-06T11:48:12Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lastUpdateTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2021-09-06T11:48:12Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">TFJob kubeflow/tfjob-simple is running.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l">TFJobRunning</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;False&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Running</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2021-09-06T11:49:30Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lastUpdateTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2021-09-06T11:49:30Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">TFJob kubeflow/tfjob-simple successfully completed.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l">TFJobSucceeded</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Succeeded</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicaStatuses</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Worker</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">succeeded</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">startTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2021-09-06T11:48:10Z&#34;</span><span class="w">
</span></span></span></code></pre></div><h3 id="conditions">Conditions</h3>
<p>A <code>TFJob</code> has a <code>TFJobStatus</code>, which has an array of <code>TFJobConditions</code> through which the <code>TFJob</code> has or has not passed.
Each element of the <code>TFJobCondition</code> array has six possible fields:</p>
<ul>
<li>The <strong>lastUpdateTime</strong> field provides the last time this condition was updated.</li>
<li>The <strong>lastTransitionTime</strong> field provides the last time the condition transitioned from one status to another.</li>
<li>The <strong>message</strong> field is a human readable message indicating details about the transition.</li>
<li>The <strong>reason</strong> field is a unique, one-word, CamelCase reason for the condition&rsquo;s
last transition.</li>
<li>The <strong>status</strong> field is a string with possible values &ldquo;True&rdquo;, &ldquo;False&rdquo;, and &ldquo;Unknown&rdquo;.</li>
<li>The <strong>type</strong> field is a string with the following possible values:
<ul>
<li><strong>TFJobCreated</strong> means the <code>TFJob</code> has been accepted by the system,
but one or more of the pods/services has not been started.</li>
<li><strong>TFJobRunning</strong> means all sub-resources (e.g. services/pods) of this <code>TFJob</code>
have been successfully scheduled and launched and the job is running.</li>
<li><strong>TFJobRestarting</strong> means one or more sub-resources (e.g. services/pods)
of this <code>TFJob</code> had a problem and is being restarted.</li>
<li><strong>TFJobSucceeded</strong> means the job completed successfully.</li>
<li><strong>TFJobFailed</strong> means the job has failed.</li>
</ul>
</li>
</ul>
<p>Success or failure of a job is determined as follows</p>
<ul>
<li>If a job has a <strong>chief</strong>, success or failure is determined by the status
of the chief.</li>
<li>If a job has no chief, success or failure is determined by the workers.</li>
<li>In both cases, the <code>TFJob</code> succeeds if the process being monitored exits
with exit code 0.</li>
<li>In the case of non-zero exit code, the behavior is determined by the restartPolicy
for the replica.</li>
<li>If the restartPolicy allows for restarts then the process will just be restarted and the <code>TFJob</code> will continue to execute.
<ul>
<li>For the restartPolicy ExitCode the behavior is exit code dependent.</li>
<li>If the restartPolicy doesn&rsquo;t allow restarts a non-zero exit code is considered
a permanent failure and the job is marked failed.</li>
</ul>
</li>
</ul>
<h3 id="tfreplicastatuses">tfReplicaStatuses</h3>
<p>tfReplicaStatuses provides a map indicating the number of pods for each
replica in a given state. There are three possible states</p>
<ul>
<li><strong>Active</strong> is the number of currently running pods.</li>
<li><strong>Succeeded</strong> is the number of pods that completed successfully.</li>
<li><strong>Failed</strong> is the number of pods that completed with an error.</li>
</ul>
<h3 id="events">Events</h3>
<p>During execution, <code>TFJob</code> will emit events to indicate whats happening such
as the creation/deletion of pods and services. Kubernetes doesn&rsquo;t retain
events older than 1 hour by default. To see recent events for a job run</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl -n kubeflow describe tfjobs tfjob-simple
</span></span></code></pre></div><p>which will produce output like</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Name:         tfjob-simple
</span></span><span class="line"><span class="cl">Namespace:    kubeflow
</span></span><span class="line"><span class="cl">Labels:       &lt;none&gt;
</span></span><span class="line"><span class="cl">Annotations:  &lt;none&gt;
</span></span><span class="line"><span class="cl">API Version:  kubeflow.org/v1
</span></span><span class="line"><span class="cl">Kind:         TFJob
</span></span><span class="line"><span class="cl">Metadata:
</span></span><span class="line"><span class="cl">  Creation Timestamp:  2021-09-06T11:48:09Z
</span></span><span class="line"><span class="cl">  Generation:          1
</span></span><span class="line"><span class="cl">  Managed Fields:
</span></span><span class="line"><span class="cl">    API Version:  kubeflow.org/v1
</span></span><span class="line"><span class="cl">    Fields Type:  FieldsV1
</span></span><span class="line"><span class="cl">    fieldsV1:
</span></span><span class="line"><span class="cl">      f:spec:
</span></span><span class="line"><span class="cl">        .:
</span></span><span class="line"><span class="cl">        f:tfReplicaSpecs:
</span></span><span class="line"><span class="cl">          .:
</span></span><span class="line"><span class="cl">          f:Worker:
</span></span><span class="line"><span class="cl">            .:
</span></span><span class="line"><span class="cl">            f:replicas:
</span></span><span class="line"><span class="cl">            f:restartPolicy:
</span></span><span class="line"><span class="cl">            f:template:
</span></span><span class="line"><span class="cl">              .:
</span></span><span class="line"><span class="cl">              f:spec:
</span></span><span class="line"><span class="cl">    Manager:      kubectl-create
</span></span><span class="line"><span class="cl">    Operation:    Update
</span></span><span class="line"><span class="cl">    Time:         2021-09-06T11:48:09Z
</span></span><span class="line"><span class="cl">    API Version:  kubeflow.org/v1
</span></span><span class="line"><span class="cl">    Fields Type:  FieldsV1
</span></span><span class="line"><span class="cl">    fieldsV1:
</span></span><span class="line"><span class="cl">      f:spec:
</span></span><span class="line"><span class="cl">        f:runPolicy:
</span></span><span class="line"><span class="cl">          .:
</span></span><span class="line"><span class="cl">          f:cleanPodPolicy:
</span></span><span class="line"><span class="cl">        f:successPolicy:
</span></span><span class="line"><span class="cl">        f:tfReplicaSpecs:
</span></span><span class="line"><span class="cl">          f:Worker:
</span></span><span class="line"><span class="cl">            f:template:
</span></span><span class="line"><span class="cl">              f:metadata:
</span></span><span class="line"><span class="cl">              f:spec:
</span></span><span class="line"><span class="cl">                f:containers:
</span></span><span class="line"><span class="cl">      f:status:
</span></span><span class="line"><span class="cl">        .:
</span></span><span class="line"><span class="cl">        f:completionTime:
</span></span><span class="line"><span class="cl">        f:conditions:
</span></span><span class="line"><span class="cl">        f:replicaStatuses:
</span></span><span class="line"><span class="cl">          .:
</span></span><span class="line"><span class="cl">          f:Worker:
</span></span><span class="line"><span class="cl">            .:
</span></span><span class="line"><span class="cl">            f:succeeded:
</span></span><span class="line"><span class="cl">        f:startTime:
</span></span><span class="line"><span class="cl">    Manager:         manager
</span></span><span class="line"><span class="cl">    Operation:       Update
</span></span><span class="line"><span class="cl">    Time:            2021-09-06T11:49:30Z
</span></span><span class="line"><span class="cl">  Resource Version:  5764004
</span></span><span class="line"><span class="cl">  Self Link:         /apis/kubeflow.org/v1/namespaces/kubeflow/tfjobs/tfjob-simple
</span></span><span class="line"><span class="cl">  UID:               3a67a9a9-cb89-4c1f-a189-f49f0b581e29
</span></span><span class="line"><span class="cl">Spec:
</span></span><span class="line"><span class="cl">  Tf Replica Specs:
</span></span><span class="line"><span class="cl">    Worker:
</span></span><span class="line"><span class="cl">      Replicas:        2
</span></span><span class="line"><span class="cl">      Restart Policy:  OnFailure
</span></span><span class="line"><span class="cl">      Template:
</span></span><span class="line"><span class="cl">        Spec:
</span></span><span class="line"><span class="cl">          Containers:
</span></span><span class="line"><span class="cl">            Command:
</span></span><span class="line"><span class="cl">              python
</span></span><span class="line"><span class="cl">              /var/tf_mnist/mnist_with_summaries.py
</span></span><span class="line"><span class="cl">            Image:  gcr.io/kubeflow-ci/tf-mnist-with-summaries:1.0
</span></span><span class="line"><span class="cl">            Name:   tensorflow
</span></span><span class="line"><span class="cl">Status:
</span></span><span class="line"><span class="cl">  Completion Time:  2021-09-06T11:49:30Z
</span></span><span class="line"><span class="cl">  Conditions:
</span></span><span class="line"><span class="cl">    Last Transition Time:  2021-09-06T11:48:09Z
</span></span><span class="line"><span class="cl">    Last Update Time:      2021-09-06T11:48:09Z
</span></span><span class="line"><span class="cl">    Message:               TFJob tfjob-simple is created.
</span></span><span class="line"><span class="cl">    Reason:                TFJobCreated
</span></span><span class="line"><span class="cl">    Status:                True
</span></span><span class="line"><span class="cl">    Type:                  Created
</span></span><span class="line"><span class="cl">    Last Transition Time:  2021-09-06T11:48:12Z
</span></span><span class="line"><span class="cl">    Last Update Time:      2021-09-06T11:48:12Z
</span></span><span class="line"><span class="cl">    Message:               TFJob kubeflow/tfjob-simple is running.
</span></span><span class="line"><span class="cl">    Reason:                TFJobRunning
</span></span><span class="line"><span class="cl">    Status:                False
</span></span><span class="line"><span class="cl">    Type:                  Running
</span></span><span class="line"><span class="cl">    Last Transition Time:  2021-09-06T11:49:30Z
</span></span><span class="line"><span class="cl">    Last Update Time:      2021-09-06T11:49:30Z
</span></span><span class="line"><span class="cl">    Message:               TFJob kubeflow/tfjob-simple successfully completed.
</span></span><span class="line"><span class="cl">    Reason:                TFJobSucceeded
</span></span><span class="line"><span class="cl">    Status:                True
</span></span><span class="line"><span class="cl">    Type:                  Succeeded
</span></span><span class="line"><span class="cl">  Replica Statuses:
</span></span><span class="line"><span class="cl">    Worker:
</span></span><span class="line"><span class="cl">      Succeeded:  2
</span></span><span class="line"><span class="cl">  Start Time:     2021-09-06T11:48:10Z
</span></span><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">  Type    Reason                   Age                    From              Message
</span></span><span class="line"><span class="cl">  ----    ------                   ----                   ----              -------
</span></span><span class="line"><span class="cl">  Normal  SuccessfulCreatePod      7m9s                   tfjob-controller  Created pod: tfjob-simple-worker-0
</span></span><span class="line"><span class="cl">  Normal  SuccessfulCreatePod      7m8s                   tfjob-controller  Created pod: tfjob-simple-worker-1
</span></span><span class="line"><span class="cl">  Normal  SuccessfulCreateService  7m8s                   tfjob-controller  Created service: tfjob-simple-worker-0
</span></span><span class="line"><span class="cl">  Normal  SuccessfulCreateService  7m8s                   tfjob-controller  Created service: tfjob-simple-worker-1
</span></span><span class="line"><span class="cl">  Normal  ExitedWithCode           5m48s (x3 over 5m48s)  tfjob-controller  Pod: kubeflow.tfjob-simple-worker-1 exited with code 0
</span></span><span class="line"><span class="cl">  Normal  ExitedWithCode           5m48s                  tfjob-controller  Pod: kubeflow.tfjob-simple-worker-0 exited with code 0
</span></span><span class="line"><span class="cl">  Normal  TFJobSucceeded           5m48s                  tfjob-controller  TFJob kubeflow/tfjob-simple successfully completed.
</span></span></code></pre></div><p>Here the events indicate that the pods and services were successfully created.</p>
<h2 id="tensorflow-logs">TensorFlow Logs</h2>
<p>Logging follows standard K8s logging practices.</p>
<p>You can use kubectl to get standard output/error for any pods
that haven&rsquo;t been <strong>deleted</strong>.</p>
<p>First find the pod created by the job controller for the replica of
interest. Pods will be named</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">${JOBNAME}-${REPLICA-TYPE}-${INDEX}
</span></span></code></pre></div><p>Once you&rsquo;ve identified your pod you can get the logs using kubectl.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl logs ${PODNAME}
</span></span></code></pre></div><p>The <strong>CleanPodPolicy</strong> in the <code>TFJob</code> spec controls deletion of pods when a job terminates.
The policy can be one of the following values</p>
<ul>
<li>The <strong>Running</strong> policy means that only pods still running when a job completes
(e.g. parameter servers) will be deleted immediately; completed pods will
not be deleted so that the logs will be preserved. This is the default value.</li>
<li>The <strong>All</strong> policy means all pods even completed pods will be deleted immediately
when the job finishes.</li>
<li>The <strong>None</strong> policy means that no pods will be deleted when the job completes.</li>
</ul>
<p>If your cluster takes advantage of Kubernetes
<a href="https://kubernetes.io/docs/concepts/cluster-administration/logging/">cluster logging</a>
then your logs may also be shipped to an appropriate data store for
further analysis.</p>
<h3 id="stackdriver-on-gke">Stackdriver on GKE</h3>
<p>See the guide to <a href="/docs/gke/monitoring/">logging and monitoring</a> for
instructions on getting logs using Stackdriver.</p>
<p>As described in the guide to
<a href="https://www.kubeflow.org/docs/gke/monitoring/#filter-with-labels">logging and monitoring</a>,
it&rsquo;s possible to fetch the logs for a particular replica based on pod labels.</p>
<p>Using the Stackdriver UI you can use a query like</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">resource.type=&#34;k8s_container&#34;
</span></span><span class="line"><span class="cl">resource.labels.cluster_name=&#34;${CLUSTER}&#34;
</span></span><span class="line"><span class="cl">metadata.userLabels.job-name=&#34;${JOB_NAME}&#34;
</span></span><span class="line"><span class="cl">metadata.userLabels.replica-type=&#34;${TYPE}&#34;
</span></span><span class="line"><span class="cl">metadata.userLabels.replica-index=&#34;${INDEX}&#34;
</span></span></code></pre></div><p>Alternatively using gcloud</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">QUERY=&#34;resource.type=\&#34;k8s_container\&#34; &#34;
</span></span><span class="line"><span class="cl">QUERY=&#34;${QUERY} resource.labels.cluster_name=\&#34;${CLUSTER}\&#34; &#34;
</span></span><span class="line"><span class="cl">QUERY=&#34;${QUERY} metadata.userLabels.job-name=\&#34;${JOB_NAME}\&#34; &#34;
</span></span><span class="line"><span class="cl">QUERY=&#34;${QUERY} metadata.userLabels.replica-type=\&#34;${TYPE}\&#34; &#34;
</span></span><span class="line"><span class="cl">QUERY=&#34;${QUERY} metadata.userLabels.replica-index=\&#34;${INDEX}\&#34; &#34;
</span></span><span class="line"><span class="cl">gcloud --project=${PROJECT} logging read  \
</span></span><span class="line"><span class="cl">     --freshness=24h \
</span></span><span class="line"><span class="cl">     --order asc  ${QUERY}
</span></span></code></pre></div><h2 id="troubleshooting">Troubleshooting</h2>
<p>Here are some steps to follow to troubleshoot your job</p>
<ol>
<li>
<p>Is a status present for your job? Run the command</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl -n ${USER_NAMESPACE} get tfjobs -o yaml ${JOB_NAME}
</span></span></code></pre></div><ul>
<li>
<p><strong>USER_NAMESPACE</strong> is the namespace created for your user profile.</p>
</li>
<li>
<p>If the resulting output doesn&rsquo;t include a status for your job then this typically
indicates the job spec is invalid.</p>
</li>
<li>
<p>If the <code>TFJob</code> spec is invalid there should be a log message in the tf operator logs</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl -n ${KUBEFLOW_NAMESPACE} logs `kubectl get pods --selector=name=tf-job-operator -o jsonpath=&#39;{.items[0].metadata.name}&#39;`
</span></span></code></pre></div><ul>
<li><strong>KUBEFLOW_NAMESPACE</strong> Is the namespace you deployed the <code>TFJob</code> operator in.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Check the events for your job to see if the pods were created</p>
<ul>
<li>
<p>There are a number of ways to get the events; if your job is less than <strong>1 hour old</strong>
then you can do</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl -n ${USER_NAMESPACE} describe tfjobs ${JOB_NAME}
</span></span></code></pre></div></li>
<li>
<p>The bottom of the output should include a list of events emitted by the job; e.g.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">Events</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="l">Type    Reason                   Age   From              Message</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span>---- <span class="w">   </span>------ <span class="w">                  </span>---- <span class="w"> </span>---- <span class="w">             </span>-------<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">Normal  SuccessfulCreatePod      90s   tfjob-controller  Created pod</span><span class="p">:</span><span class="w"> </span><span class="l">tfjob2-worker-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">Normal  SuccessfulCreatePod      90s   tfjob-controller  Created pod</span><span class="p">:</span><span class="w"> </span><span class="l">tfjob2-ps-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">Normal  SuccessfulCreateService  90s   tfjob-controller  Created service</span><span class="p">:</span><span class="w"> </span><span class="l">tfjob2-worker-0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nt">Normal  SuccessfulCreateService  90s   tfjob-controller  Created service</span><span class="p">:</span><span class="w"> </span><span class="l">tfjob2-ps-0</span><span class="w">
</span></span></span></code></pre></div></li>
<li>
<p>Kubernetes only preserves events for <strong>1 hour</strong> (see <a href="https://github.com/kubernetes/kubernetes/issues/52521">kubernetes/kubernetes#52521</a>)</p>
<ul>
<li>Depending on your cluster setup events might be persisted to external storage and accessible for longer periods</li>
<li>On GKE events are persisted in stackdriver and can be accessed using the instructions in the previous section.</li>
</ul>
</li>
<li>
<p>If the pods and services aren&rsquo;t being created then this suggests the <code>TFJob</code> isn&rsquo;t being processed; common causes are</p>
<ul>
<li>The <code>TFJob</code> spec is invalid (see above)</li>
<li>The <code>TFJob</code> operator isn&rsquo;t running</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Check the events for the pods to ensure they are scheduled.</p>
<ul>
<li>
<p>There are a number of ways to get the events; if your pod is less than <strong>1 hour old</strong>
then you can do</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> kubectl -n ${USER_NAMESPACE} describe pods ${POD_NAME}
</span></span></code></pre></div></li>
<li>
<p>The bottom of the output should contain events like the following</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Events:
</span></span><span class="line"><span class="cl">Type    Reason                 Age   From                                                  Message
</span></span><span class="line"><span class="cl">----    ------                 ----  ----                                                  -------
</span></span><span class="line"><span class="cl">Normal  Scheduled              18s   default-scheduler                                     Successfully assigned tfjob2-ps-0 to gke-jl-kf-v0-2-2-default-pool-347936c1-1qkt
</span></span><span class="line"><span class="cl">Normal  SuccessfulMountVolume  17s   kubelet, gke-jl-kf-v0-2-2-default-pool-347936c1-1qkt  MountVolume.SetUp succeeded for volume &#34;default-token-h8rnv&#34;
</span></span><span class="line"><span class="cl">Normal  Pulled                 17s   kubelet, gke-jl-kf-v0-2-2-default-pool-347936c1-1qkt  Container image &#34;gcr.io/kubeflow/tf-benchmarks-cpu:v20171202-bdab599-dirty-284af3&#34; already present on machine
</span></span><span class="line"><span class="cl">Normal  Created                17s   kubelet, gke-jl-kf-v0-2-2-default-pool-347936c1-1qkt  Created container
</span></span><span class="line"><span class="cl">Normal  Started                16s   kubelet, gke-jl-kf-v0-2-2-default-pool-347936c1-1qkt  Started container
</span></span></code></pre></div></li>
<li>
<p>Some common problems that can prevent a container from starting are</p>
<ul>
<li>Insufficient resources to schedule the pod</li>
<li>The pod tries to mount a volume (or secret) that doesn&rsquo;t exist or is unavailable</li>
<li>The docker image doesn&rsquo;t exist or can&rsquo;t be accessed (e.g due to permission issues)</li>
</ul>
</li>
</ul>
</li>
<li>
<p>If the containers start; check the logs of the containers following the instructions
in the previous section.</p>
</li>
</ol>
<h2 id="more-information">More information</h2>
<ul>
<li>Explore the <a href="/docs/reference/tfjob"><code>TFJob</code> reference documentation</a>.</li>
<li>See how to <a href="/docs/use-cases/job-scheduling#running-jobs-with-gang-scheduling">run a job with gang-scheduling</a>.</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-94aec72d7979152842ed2f8cbe6dbe06">2 - PyTorch Training (PyTorchJob)</h1>
    <div class="lead">Using PyTorchJob to train a model with PyTorch</div>
	<div class="alert alert-primary" role="alert">
This Kubeflow component has <b>stable</b> status. See the
<a href="/docs/started/support/#application-status">Kubeflow versioning policies</a>.
</div>
<p>This page describes <code>PyTorchJob</code> for training a machine learning model with <a href="https://pytorch.org/">PyTorch</a>.</p>
<p><code>PyTorchJob</code> is a Kubernetes
<a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">custom resource</a>
to run PyTorch training jobs on Kubernetes. The Kubeflow implementation of
<code>PyTorchJob</code> is in <a href="https://github.com/kubeflow/training-operator"><code>training-operator</code></a>.</p>
<h2 id="installing-pytorch-operator">Installing PyTorch Operator</h2>
<p>If you haven&rsquo;t already done so please follow the <a href="/docs/started/getting-started/">Getting Started Guide</a> to deploy Kubeflow.</p>
<blockquote>
<p>By default, PyTorch Operator will be deployed as a controller in training operator.</p>
</blockquote>
<p>If you want to install a standalone version of the training operator without Kubeflow,
see the <a href="https://github.com/kubeflow/training-operator#installation">kubeflow/training-operator&rsquo;s README</a>.</p>
<h3 id="verify-that-pytorchjob-support-is-included-in-your-kubeflow-deployment">Verify that PyTorchJob support is included in your Kubeflow deployment</h3>
<p>Check that the PyTorch custom resource is installed:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl get crd
</span></span></code></pre></div><p>The output should include <code>pytorchjobs.kubeflow.org</code> like the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">NAME                                             CREATED AT
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">pytorchjobs.kubeflow.org                         2021-09-06T18:33:58Z
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>Check that the Training operator is running via:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl get pods -n kubeflow
</span></span></code></pre></div><p>The output should include <code>training-operaror-xxx</code> like the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">NAME                                READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">training-operator-d466b46bc-xbqvs   1/1     Running   0          4m37s
</span></span></code></pre></div><h2 id="creating-a-pytorch-training-job">Creating a PyTorch training job</h2>
<p>You can create a training job by defining a <code>PyTorchJob</code> config file. See the manifests for the <a href="https://github.com/kubeflow/training-operator/blob/master/examples/pytorch/simple.yaml">distributed MNIST example</a>. You may change the config file based on your requirements.</p>
<p>Deploy the <code>PyTorchJob</code> resource to start training:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl create -f https://raw.githubusercontent.com/kubeflow/training-operator/master/examples/pytorch/simple.yaml
</span></span></code></pre></div><p>You should now be able to see the created pods matching the specified number of replicas.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl get pods -l job-name=pytorch-simple -n kubeflow
</span></span></code></pre></div><p>Training takes 5-10 minutes on a cpu cluster. Logs can be inspected to see its training progress.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PODNAME=$(kubectl get pods -l job-name=pytorch-simple,replica-type=master,replica-index=0 -o name -n kubeflow)
</span></span><span class="line"><span class="cl">kubectl logs -f ${PODNAME} -n kubeflow
</span></span></code></pre></div><h2 id="monitoring-a-pytorchjob">Monitoring a PyTorchJob</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl get -o yaml pytorchjobs pytorch-simple -n kubeflow
</span></span></code></pre></div><p>See the status section to monitor the job status. Here is sample output when the job is successfully completed.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: kubeflow.org/v1
</span></span><span class="line"><span class="cl">kind: PyTorchJob
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  clusterName: &#34;&#34;
</span></span><span class="line"><span class="cl">  creationTimestamp: 2018-12-16T21:39:09Z
</span></span><span class="line"><span class="cl">  generation: 1
</span></span><span class="line"><span class="cl">  name: pytorch-tcp-dist-mnist
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  resourceVersion: &#34;15532&#34;
</span></span><span class="line"><span class="cl">  selfLink: /apis/kubeflow.org/v1/namespaces/default/pytorchjobs/pytorch-tcp-dist-mnist
</span></span><span class="line"><span class="cl">  uid: 059391e8-017b-11e9-bf13-06afd8f55a5c
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  cleanPodPolicy: None
</span></span><span class="line"><span class="cl">  pytorchReplicaSpecs:
</span></span><span class="line"><span class="cl">    Master:
</span></span><span class="line"><span class="cl">      replicas: 1
</span></span><span class="line"><span class="cl">      restartPolicy: OnFailure
</span></span><span class="line"><span class="cl">      template:
</span></span><span class="line"><span class="cl">        metadata:
</span></span><span class="line"><span class="cl">          creationTimestamp: null
</span></span><span class="line"><span class="cl">        spec:
</span></span><span class="line"><span class="cl">          containers:
</span></span><span class="line"><span class="cl">          - image: gcr.io/kubeflow-ci/pytorch-dist-mnist_test:1.0
</span></span><span class="line"><span class="cl">            name: pytorch
</span></span><span class="line"><span class="cl">            ports:
</span></span><span class="line"><span class="cl">            - containerPort: 23456
</span></span><span class="line"><span class="cl">              name: pytorchjob-port
</span></span><span class="line"><span class="cl">            resources: {}
</span></span><span class="line"><span class="cl">    Worker:
</span></span><span class="line"><span class="cl">      replicas: 3
</span></span><span class="line"><span class="cl">      restartPolicy: OnFailure
</span></span><span class="line"><span class="cl">      template:
</span></span><span class="line"><span class="cl">        metadata:
</span></span><span class="line"><span class="cl">          creationTimestamp: null
</span></span><span class="line"><span class="cl">        spec:
</span></span><span class="line"><span class="cl">          containers:
</span></span><span class="line"><span class="cl">          - image: gcr.io/kubeflow-ci/pytorch-dist-mnist_test:1.0
</span></span><span class="line"><span class="cl">            name: pytorch
</span></span><span class="line"><span class="cl">            ports:
</span></span><span class="line"><span class="cl">            - containerPort: 23456
</span></span><span class="line"><span class="cl">              name: pytorchjob-port
</span></span><span class="line"><span class="cl">            resources: {}
</span></span><span class="line"><span class="cl">status:
</span></span><span class="line"><span class="cl">  completionTime: 2018-12-16T21:43:27Z
</span></span><span class="line"><span class="cl">  conditions:
</span></span><span class="line"><span class="cl">  - lastTransitionTime: 2018-12-16T21:39:09Z
</span></span><span class="line"><span class="cl">    lastUpdateTime: 2018-12-16T21:39:09Z
</span></span><span class="line"><span class="cl">    message: PyTorchJob pytorch-tcp-dist-mnist is created.
</span></span><span class="line"><span class="cl">    reason: PyTorchJobCreated
</span></span><span class="line"><span class="cl">    status: &#34;True&#34;
</span></span><span class="line"><span class="cl">    type: Created
</span></span><span class="line"><span class="cl">  - lastTransitionTime: 2018-12-16T21:39:09Z
</span></span><span class="line"><span class="cl">    lastUpdateTime: 2018-12-16T21:40:45Z
</span></span><span class="line"><span class="cl">    message: PyTorchJob pytorch-tcp-dist-mnist is running.
</span></span><span class="line"><span class="cl">    reason: PyTorchJobRunning
</span></span><span class="line"><span class="cl">    status: &#34;False&#34;
</span></span><span class="line"><span class="cl">    type: Running
</span></span><span class="line"><span class="cl">  - lastTransitionTime: 2018-12-16T21:39:09Z
</span></span><span class="line"><span class="cl">    lastUpdateTime: 2018-12-16T21:43:27Z
</span></span><span class="line"><span class="cl">    message: PyTorchJob pytorch-tcp-dist-mnist is successfully completed.
</span></span><span class="line"><span class="cl">    reason: PyTorchJobSucceeded
</span></span><span class="line"><span class="cl">    status: &#34;True&#34;
</span></span><span class="line"><span class="cl">    type: Succeeded
</span></span><span class="line"><span class="cl">  replicaStatuses:
</span></span><span class="line"><span class="cl">    Master: {}
</span></span><span class="line"><span class="cl">    Worker: {}
</span></span><span class="line"><span class="cl">  startTime: 2018-12-16T21:40:45Z
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-918c00c4648652b4a145759ea270e3fe">3 - MXNet Training (MXJob)</h1>
    <div class="lead">Using MXJob to train a model with Apache MXNet</div>
	<p>This guide walks you through using <a href="https://github.com/apache/incubator-mxnet">Apache MXNet (incubating)</a> with Kubeflow.</p>
<p>MXNet Operator provides a Kubernetes custom resource <code>MXJob</code> that makes it easy to run distributed or non-distributed
Apache MXNet jobs (training and tuning) and other extended framework like <a href="https://github.com/bytedance/byteps">BytePS</a>
jobs on Kubernetes. Using a Custom Resource Definition (CRD) gives users the ability to create
and manage Apache MXNet jobs just like built-in K8S resources.</p>
<p>The Kubeflow implementation of <code>MXJob</code> is in <a href="https://github.com/kubeflow/training-operator"><code>training-operator</code></a>.</p>
<h2 id="installing-mxnet-operator">Installing MXNet Operator</h2>
<p>If you haven&rsquo;t already done so please follow the <a href="/docs/started/getting-started/">Getting Started Guide</a> to deploy Kubeflow.</p>
<blockquote>
<p>By default, MXNet Operator will be deployed as a controller in training operator.</p>
</blockquote>
<p>If you want to install a standalone version of the training operator without Kubeflow,
see the <a href="https://github.com/kubeflow/training-operator#installation">kubeflow/training-operator&rsquo;s README</a>.</p>
<h3 id="verify-that-mxjob-support-is-included-in-your-kubeflow-deployment">Verify that MXJob support is included in your Kubeflow deployment</h3>
<p>Check that the Apache MXNet custom resource is installed:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl get crd
</span></span></code></pre></div><p>The output should include <code>mxjobs.kubeflow.org</code> like the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">NAME                                             CREATED AT
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">mxjobs.kubeflow.org                              2021-09-06T18:33:57Z
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>Check that the Training operator is running via:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl get pods -n kubeflow
</span></span></code></pre></div><p>The output should include <code>training-operator-xxx</code> like the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">NAME                                READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">training-operator-d466b46bc-xbqvs   1/1     Running   0          4m37s
</span></span></code></pre></div><h2 id="creating-a-apache-mxnet-training-job">Creating a Apache MXNet training job</h2>
<p>You create a training job by defining a <code>MXJob</code> with <code>MXTrain</code> mode and then creating it with.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl create -f https://raw.githubusercontent.com/kubeflow/training-operator/master/examples/mxnet/train/mx_job_dist_gpu_v1.yaml
</span></span></code></pre></div><p>Each <code>mxReplicaSpecs</code> defines a set of Apache MXNet processes.
The <code>mxReplicaType</code> defines the semantics for the set of processes.
The semantics are as follows:</p>
<p><strong>scheduler</strong></p>
<ul>
<li>A job must have 1 and only 1 scheduler</li>
<li>The pod must contain a container named <code>mxnet</code></li>
<li>The overall status of the <code>MXJob</code> is determined by the exit code of the
mxnet container
<ul>
<li>0 = success</li>
<li>1 || 2 || 126 || 127 || 128 || 139 = permanent errors:
<ul>
<li>1: general errors</li>
<li>2: misuse of shell builtins</li>
<li>126: command invoked cannot execute</li>
<li>127: command not found</li>
<li>128: invalid argument to exit</li>
<li>139: container terminated by SIGSEGV(Invalid memory reference)</li>
</ul>
</li>
<li>130 || 137 || 143 = retryable error for unexpected system signals:
<ul>
<li>130: container terminated by Control-C</li>
<li>137: container received a SIGKILL</li>
<li>143: container received a SIGTERM</li>
</ul>
</li>
<li>138 = reserved in training-operator for user specified retryable errors</li>
<li>others = undefined and no guarantee</li>
</ul>
</li>
</ul>
<p><strong>worker</strong></p>
<ul>
<li>A job can have 0 to N workers</li>
<li>The pod must contain a container named mxnet</li>
<li>Workers are automatically restarted if they exit</li>
</ul>
<p><strong>server</strong></p>
<ul>
<li>A job can have 0 to N servers</li>
<li>parameter servers are automatically restarted if they exit</li>
</ul>
<p>For each replica you define a <strong>template</strong> which is a K8S
<a href="https://v1-21.docs.kubernetes.io/docs/reference/kubernetes-api/workload-resources/pod-template-v1/#PodTemplateSpec">PodTemplateSpec</a>.
The template allows you to specify the containers, volumes, etc&hellip; that
should be created for each replica.</p>
<h2 id="creating-a-tvm-tuning-job-autotvm">Creating a TVM tuning job (AutoTVM)</h2>
<p><a href="https://docs.tvm.ai/tutorials/">TVM</a> is a end to end deep learning compiler stack, you can easily run AutoTVM with MXJob.
You can create a auto tuning job by define a type of MXTune job and then creating it with</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl create -f https://raw.githubusercontent.com/kubeflow/training-operator/master/examples/mxnet/tune/mx_job_tune_gpu_v1.yaml
</span></span></code></pre></div><p>Before you use the auto-tuning example, there is some preparatory work need to be finished in advance.
To let TVM tune your network, you should create a docker image which has TVM module.
Then, you need a auto-tuning script to specify which network will be tuned and set the auto-tuning parameters.
For more details, please see <a href="https://docs.tvm.ai/tutorials/autotvm/tune_relay_mobile_gpu.html#sphx-glr-tutorials-autotvm-tune-relay-mobile-gpu-py">tutorials</a>.
Finally, you need a startup script to start the auto-tuning program. In fact,
MXJob will set all the parameters as environment variables and the startup script
needs to read these variable and then transmit them to the auto-tuning script.</p>
<h2 id="using-gpus">Using GPUs</h2>
<p>MXNet Operator supports training with GPUs.</p>
<p>Please verify your image is available for distributed training with GPUs.</p>
<p>For example, if you have the following, MXNet Operator will arrange the pod to nodes to satisfy the GPU limit.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">command: [&#34;python&#34;]
</span></span><span class="line"><span class="cl">args: [&#34;/incubator-mxnet/example/image-classification/train_mnist.py&#34;,&#34;--num-epochs&#34;,&#34;1&#34;,&#34;--num-layers&#34;,&#34;2&#34;,&#34;--kv-store&#34;,&#34;dist_device_sync&#34;,&#34;--gpus&#34;,&#34;0&#34;]
</span></span><span class="line"><span class="cl">resources:
</span></span><span class="line"><span class="cl">  limits:
</span></span><span class="line"><span class="cl">    nvidia.com/gpu: 1
</span></span></code></pre></div><h2 id="monitoring-your-apache-mxnet-job">Monitoring your Apache MXNet job</h2>
<p>To get the status of your job</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl get -o yaml mxjobs <span class="nv">$JOB</span>
</span></span></code></pre></div><p>Here is sample output for an example job</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeflow.org/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">MXJob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="ld">2021-03-24T15:37:27Z</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mxnet-job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;5123435&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selfLink</span><span class="p">:</span><span class="w"> </span><span class="l">/apis/kubeflow.org/v1/namespaces/default/mxjobs/mxnet-job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">xx11013b-4a28-11e9-s5a1-704d7bb912f91</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">runPolicy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cleanPodPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">All</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobMode</span><span class="p">:</span><span class="w"> </span><span class="l">MXTrain</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mxReplicaSpecs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Scheduler</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">mxjob/mxnet:gpu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mxnet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9091</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mxjob-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">mxjob/mxnet:gpu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mxnet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9091</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mxjob-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Worker</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">/incubator-mxnet/example/image-classification/train_mnist.py</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">num-epochs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="s2">&#34;10&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">num-layers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="s2">&#34;2&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">kv-store</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">dist_device_sync</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">gpus</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">python</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">mxjob/mxnet:gpu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mxnet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9091</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mxjob-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">nvidia.com/gpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">completionTime</span><span class="p">:</span><span class="w"> </span><span class="ld">2021-03-24T09:25:11Z</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="ld">2021-03-24T15:37:27Z</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lastUpdateTime</span><span class="p">:</span><span class="w"> </span><span class="ld">2021-03-24T15:37:27Z</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">MXJob mxnet-job is created.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l">MXJobCreated</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Created</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="ld">2021-03-24T15:37:27Z</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lastUpdateTime</span><span class="p">:</span><span class="w"> </span><span class="ld">2021-03-24T15:37:29Z</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">MXJob mxnet-job is running.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l">MXJobRunning</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;False&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Running</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="ld">2021-03-24T15:37:27Z</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lastUpdateTime</span><span class="p">:</span><span class="w"> </span><span class="ld">2021-03-24T09:25:11Z</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">MXJob mxnet-job is successfully completed.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l">MXJobSucceeded</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Succeeded</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mxReplicaStatuses</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Scheduler</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Server</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Worker</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">startTime</span><span class="p">:</span><span class="w"> </span><span class="ld">2021-03-24T15:37:29Z</span><span class="w">
</span></span></span></code></pre></div><p>The first thing to note is the <strong>RuntimeId</strong>. This is a random unique
string which is used to give names to all the K8s resouces
(e.g Job controllers &amp; services) that are created by the <code>MXJob</code>.</p>
<p>As with other K8S resources status provides information about the state
of the resource.</p>
<p><strong>phase</strong> - Indicates the phase of a job and will be one of</p>
<ul>
<li>Creating</li>
<li>Running</li>
<li>CleanUp</li>
<li>Failed</li>
<li>Done</li>
</ul>
<p><strong>state</strong> - Provides the overall status of the job and will be one of</p>
<ul>
<li>Running</li>
<li>Succeeded</li>
<li>Failed</li>
</ul>
<p>For each replica type in the job, there will be a <code>ReplicaStatus</code> that
provides the number of replicas of that type in each state.</p>
<p>For each replica type, the job creates a set of K8s
<a href="https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/">Job Controllers</a>
named</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">${REPLICA-TYPE}-${RUNTIME_ID}-${INDEX}
</span></span></code></pre></div><p>For example, if you have 2 servers and the runtime id is &ldquo;76n0&rdquo;, then <code>MXJob</code>
will create the following two jobs:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">server-76no-0
</span></span><span class="line"><span class="cl">server-76no-1
</span></span></code></pre></div><h2 id="more-information">More Information</h2>
<ul>
<li>Check out <a href="https://www.kubeflow.org/docs/about/community/">Kubeflow community page</a>
for more information on how to get involved in our community.</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-66d70221609b85eb891d6f7d3b11fbe6">4 - XGBoost Training (XGBoostJob)</h1>
    <div class="lead">Using XGBoostJob to train a model with XGBoost</div>
	<div class="alert alert-primary" role="alert">
This Kubeflow component has <b>stable</b> status. See the
<a href="/docs/started/support/#application-status">Kubeflow versioning policies</a>.
</div>
<p>This page describes <code>XGBoostJob</code> for training a machine learning model with <a href="https://github.com/dmlc/xgboost">XGBoost</a>.</p>
<p><code>XGBoostJob</code> is a Kubernetes
<a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">custom resource</a>
to run XGBoost training jobs on Kubernetes. The Kubeflow implementation of
<code>XGBoostJob</code> is in <a href="https://github.com/kubeflow/training-operator"><code>training-operator</code></a>.</p>
<h2 id="installing-xgboost-operator">Installing XGBoost Operator</h2>
<p>If you haven&rsquo;t already done so please follow the <a href="/docs/started/getting-started/">Getting Started Guide</a> to deploy Kubeflow.</p>
<blockquote>
<p>By default, XGBoost Operator will be deployed as a controller in training operator.</p>
</blockquote>
<p>If you want to install a standalone version of the training operator without Kubeflow,
see the <a href="https://github.com/kubeflow/training-operator#installation">kubeflow/training-operator&rsquo;s README</a>.</p>
<h2 id="verify-that-xgboost-support-is-included-in-your-kubeflow-deployment">Verify that XGBoost support is included in your Kubeflow deployment</h2>
<p>Check that the XGboost custom resource is installed</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl get crd
</span></span></code></pre></div><p>The output should include <code>xgboostjobs.kubeflow.org</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">NAME                                           AGE
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">xgboostjobs.kubeflow.org                       4d
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>Check that the Training operator is running via:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl get pods -n kubeflow
</span></span></code></pre></div><p>The output should include <code>training-operator-xxx</code> like the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">NAME                                READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">training-operator-d466b46bc-xbqvs   1/1     Running   0          4m37s
</span></span></code></pre></div><h2 id="creating-a-xgboost-training-job">Creating a XGBoost training job</h2>
<p>You can create a training job by defining a <code>XGboostJob</code> config file. See the
manifests for the <a href="https://github.com/kubeflow/training-operator/blob/master/examples/xgboost/xgboostjob.yaml">IRIS example</a>.
You may change the config file based on your requirements. E.g.: add <code>CleanPodPolicy</code>
in Spec to <code>None</code> to retain pods after job termination.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cat xgboostjob.yaml
</span></span></code></pre></div><p>Deploy the <code>XGBoostJob</code> resource to start training:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl create -f xgboostjob.yaml
</span></span></code></pre></div><p>You should now be able to see the created pods matching the specified number of replicas.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl get pods -l job-name=xgboost-dist-iris-test-train
</span></span></code></pre></div><p>Training takes 5-10 minutes on a cpu cluster. Logs can be inspected to see its training progress.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PODNAME=$(kubectl get pods -l job-name=xgboost-dist-iris-test-train,replica-type=master,replica-index=0 -o name)
</span></span><span class="line"><span class="cl">kubectl logs -f ${PODNAME}
</span></span></code></pre></div><h2 id="monitoring-a-xgboostjob">Monitoring a XGBoostJob</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl get -o yaml xgboostjobs xgboost-dist-iris-test-train
</span></span></code></pre></div><p>See the status section to monitor the job status. Here is sample output when the job is successfully completed.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeflow.org/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">XGBoostJob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2021-09-06T18:34:06Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">generation</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">xgboost-dist-iris-test-train</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;5844304&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selfLink</span><span class="p">:</span><span class="w"> </span><span class="l">/apis/kubeflow.org/v1/namespaces/default/xgboostjobs/xgboost-dist-iris-test-train</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">a1ea6675-3cb5-482b-95dd-68b2c99b8adc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">runPolicy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">cleanPodPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">xgbReplicaSpecs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Master</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">job_type=Train</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">xgboost_parameter=objective:multi:softprob,num_class:3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">n_estimators=10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">learning_rate=0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">model_path=/tmp/xgboost-model</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">model_storage_type=local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">docker.io/merlintang/xgboost-dist-iris:1.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">xgboost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9991</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">xgboostjob-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Worker</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">ExitCode</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">job_type=Train</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">xgboost_parameter=&#34;objective:multi:softprob,num_class:3&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">n_estimators=10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">learning_rate=0.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">docker.io/merlintang/xgboost-dist-iris:1.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">xgboost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9991</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">xgboostjob-port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">completionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2021-09-06T18:34:23Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2021-09-06T18:34:06Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lastUpdateTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2021-09-06T18:34:06Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">xgboostJob xgboost-dist-iris-test-train is created.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l">XGBoostJobCreated</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Created</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2021-09-06T18:34:06Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lastUpdateTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2021-09-06T18:34:06Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">XGBoostJob xgboost-dist-iris-test-train is running.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l">XGBoostJobRunning</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;False&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Running</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2021-09-06T18:34:23Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lastUpdateTime</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2021-09-06T18:34:23Z&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="l">XGBoostJob xgboost-dist-iris-test-train is successfully completed.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l">XGBoostJobSucceeded</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;True&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Succeeded</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicaStatuses</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Master</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">succeeded</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Worker</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">succeeded</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e31f8fe300fca877319ecc67f6f703f2">5 - MPI Training (MPIJob)</h1>
    <div class="lead">Instructions for using MPI for training</div>
	<div class="alert alert-warning" role="alert">
  <h4 class="alert-heading">Alpha</h4>
  This Kubeflow component has <b>alpha</b> status with limited support. See the
  <a href="/docs/started/support/#application-status">Kubeflow versioning policies</a>.
  The Kubeflow team is interested in your   
  <a href="https://github.com/kubeflow/mpi-operator/issues">feedback</a></h4> 
  about the usability of the feature.
</div>
<p>This guide walks you through using MPI for training.</p>
<p>The MPI Operator makes it easy to run allreduce-style distributed training on Kubernetes. Please check out <a href="https://medium.com/kubeflow/introduction-to-kubeflow-mpi-operator-and-industry-adoption-296d5f2e6edc">this blog post</a> for an introduction to MPI Operator and its industry adoption.</p>
<h2 id="installation">Installation</h2>
<p>You can deploy the operator with default settings by running the following commands:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">git clone https://github.com/kubeflow/mpi-operator
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> mpi-operator
</span></span><span class="line"><span class="cl">kubectl apply -f deploy/v2beta1/mpi-operator.yaml
</span></span></code></pre></div><p>Alternatively, follow the <a href="https://www.kubeflow.org/docs/started/getting-started/">getting started guide</a> to deploy Kubeflow.</p>
<p>An alpha version of MPI support was introduced with Kubeflow 0.2.0. You must be using a version of Kubeflow newer than 0.2.0.</p>
<p>You can check whether the MPI Job custom resource is installed via:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl get crd
</span></span></code></pre></div><p>The output should include <code>mpijobs.kubeflow.org</code> like the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">NAME                                       AGE
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">mpijobs.kubeflow.org                       4d
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>If it is not included, you can add it as follows using <a href="https://github.com/kubernetes-sigs/kustomize">kustomize</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://github.com/kubeflow/mpi-operator
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> mpi-operator
</span></span><span class="line"><span class="cl">kustomize build manifests/overlays/kubeflow <span class="p">|</span> kubectl apply -f -
</span></span></code></pre></div><p>Note that since Kubernetes v1.14, <code>kustomize</code> became a subcommand in <code>kubectl</code> so you can also run the following command instead:</p>
<p>Since Kubernetes v1.21, you can use:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl apply -k manifests/overlays/kubeflow
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl kustomize base <span class="p">|</span> kubectl apply -f -
</span></span></code></pre></div><h2 id="creating-an-mpi-job">Creating an MPI Job</h2>
<p>You can create an MPI job by defining an <code>MPIJob</code> config file. See <a href="https://github.com/kubeflow/mpi-operator/blob/master/examples/v2beta1/tensorflow-benchmarks.yaml">TensorFlow benchmark example</a> config file for launching a multi-node TensorFlow benchmark training job. You may change the config file based on your requirements.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">cat examples/v2beta1/tensorflow-benchmarks.yaml
</span></span></code></pre></div><p>Deploy the <code>MPIJob</code> resource to start training:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl apply -f examples/v2beta1/tensorflow-benchmarks.yaml
</span></span></code></pre></div><h2 id="monitoring-an-mpi-job">Monitoring an MPI Job</h2>
<p>Once the <code>MPIJob</code> resource is created, you should now be able to see the created pods matching the specified number of GPUs. You can also monitor the job status from the status section. Here is sample output when the job is successfully completed.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl get -o yaml mpijobs tensorflow-benchmarks
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">apiVersion: kubeflow.org/v2beta1
</span></span><span class="line"><span class="cl">kind: MPIJob
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  creationTimestamp: &#34;2019-07-09T22:15:51Z&#34;
</span></span><span class="line"><span class="cl">  generation: 1
</span></span><span class="line"><span class="cl">  name: tensorflow-benchmarks
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">  resourceVersion: &#34;5645868&#34;
</span></span><span class="line"><span class="cl">  selfLink: /apis/kubeflow.org/v1alpha2/namespaces/default/mpijobs/tensorflow-benchmarks
</span></span><span class="line"><span class="cl">  uid: 1c5b470f-a297-11e9-964d-88d7f67c6e6d
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  runPolicy:
</span></span><span class="line"><span class="cl">    cleanPodPolicy: Running
</span></span><span class="line"><span class="cl">  mpiReplicaSpecs:
</span></span><span class="line"><span class="cl">    Launcher:
</span></span><span class="line"><span class="cl">      replicas: 1
</span></span><span class="line"><span class="cl">      template:
</span></span><span class="line"><span class="cl">        spec:
</span></span><span class="line"><span class="cl">          containers:
</span></span><span class="line"><span class="cl">          - command:
</span></span><span class="line"><span class="cl">            - mpirun
</span></span><span class="line"><span class="cl">            - --allow-run-as-root
</span></span><span class="line"><span class="cl">            - -np
</span></span><span class="line"><span class="cl">            - &#34;2&#34;
</span></span><span class="line"><span class="cl">            - -bind-to
</span></span><span class="line"><span class="cl">            - none
</span></span><span class="line"><span class="cl">            - -map-by
</span></span><span class="line"><span class="cl">            - slot
</span></span><span class="line"><span class="cl">            - -x
</span></span><span class="line"><span class="cl">            - NCCL_DEBUG=INFO
</span></span><span class="line"><span class="cl">            - -x
</span></span><span class="line"><span class="cl">            - LD_LIBRARY_PATH
</span></span><span class="line"><span class="cl">            - -x
</span></span><span class="line"><span class="cl">            - PATH
</span></span><span class="line"><span class="cl">            - -mca
</span></span><span class="line"><span class="cl">            - pml
</span></span><span class="line"><span class="cl">            - ob1
</span></span><span class="line"><span class="cl">            - -mca
</span></span><span class="line"><span class="cl">            - btl
</span></span><span class="line"><span class="cl">            - ^openib
</span></span><span class="line"><span class="cl">            - python
</span></span><span class="line"><span class="cl">            - scripts/tf_cnn_benchmarks/tf_cnn_benchmarks.py
</span></span><span class="line"><span class="cl">            - --model=resnet101
</span></span><span class="line"><span class="cl">            - --batch_size=64
</span></span><span class="line"><span class="cl">            - --variable_update=horovod
</span></span><span class="line"><span class="cl">            image: mpioperator/tensorflow-benchmarks:latest
</span></span><span class="line"><span class="cl">            name: tensorflow-benchmarks
</span></span><span class="line"><span class="cl">    Worker:
</span></span><span class="line"><span class="cl">      replicas: 1
</span></span><span class="line"><span class="cl">      template:
</span></span><span class="line"><span class="cl">        spec:
</span></span><span class="line"><span class="cl">          containers:
</span></span><span class="line"><span class="cl">          - image: mpioperator/tensorflow-benchmarks:latest
</span></span><span class="line"><span class="cl">            name: tensorflow-benchmarks
</span></span><span class="line"><span class="cl">            resources:
</span></span><span class="line"><span class="cl">              limits:
</span></span><span class="line"><span class="cl">                nvidia.com/gpu: 2
</span></span><span class="line"><span class="cl">  slotsPerWorker: 2
</span></span><span class="line"><span class="cl">status:
</span></span><span class="line"><span class="cl">  completionTime: &#34;2019-07-09T22:17:06Z&#34;
</span></span><span class="line"><span class="cl">  conditions:
</span></span><span class="line"><span class="cl">  - lastTransitionTime: &#34;2019-07-09T22:15:51Z&#34;
</span></span><span class="line"><span class="cl">    lastUpdateTime: &#34;2019-07-09T22:15:51Z&#34;
</span></span><span class="line"><span class="cl">    message: MPIJob default/tensorflow-benchmarks is created.
</span></span><span class="line"><span class="cl">    reason: MPIJobCreated
</span></span><span class="line"><span class="cl">    status: &#34;True&#34;
</span></span><span class="line"><span class="cl">    type: Created
</span></span><span class="line"><span class="cl">  - lastTransitionTime: &#34;2019-07-09T22:15:54Z&#34;
</span></span><span class="line"><span class="cl">    lastUpdateTime: &#34;2019-07-09T22:15:54Z&#34;
</span></span><span class="line"><span class="cl">    message: MPIJob default/tensorflow-benchmarks is running.
</span></span><span class="line"><span class="cl">    reason: MPIJobRunning
</span></span><span class="line"><span class="cl">    status: &#34;False&#34;
</span></span><span class="line"><span class="cl">    type: Running
</span></span><span class="line"><span class="cl">  - lastTransitionTime: &#34;2019-07-09T22:17:06Z&#34;
</span></span><span class="line"><span class="cl">    lastUpdateTime: &#34;2019-07-09T22:17:06Z&#34;
</span></span><span class="line"><span class="cl">    message: MPIJob default/tensorflow-benchmarks successfully completed.
</span></span><span class="line"><span class="cl">    reason: MPIJobSucceeded
</span></span><span class="line"><span class="cl">    status: &#34;True&#34;
</span></span><span class="line"><span class="cl">    type: Succeeded
</span></span><span class="line"><span class="cl">  replicaStatuses:
</span></span><span class="line"><span class="cl">    Launcher:
</span></span><span class="line"><span class="cl">      succeeded: 1
</span></span><span class="line"><span class="cl">    Worker: {}
</span></span><span class="line"><span class="cl">  startTime: &#34;2019-07-09T22:15:51Z&#34;
</span></span></code></pre></div><p>Training should run for 100 steps and takes a few minutes on a GPU cluster. You can inspect the logs to see the training progress. When the job starts, access the logs from the <code>launcher</code> pod:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PODNAME=$(kubectl get pods -l mpi_job_name=tensorflow-benchmarks,mpi_role_type=launcher -o name)
</span></span><span class="line"><span class="cl">kubectl logs -f ${PODNAME}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">TensorFlow:  1.14
</span></span><span class="line"><span class="cl">Model:       resnet101
</span></span><span class="line"><span class="cl">Dataset:     imagenet (synthetic)
</span></span><span class="line"><span class="cl">Mode:        training
</span></span><span class="line"><span class="cl">SingleSess:  False
</span></span><span class="line"><span class="cl">Batch size:  128 global
</span></span><span class="line"><span class="cl">             64 per device
</span></span><span class="line"><span class="cl">Num batches: 100
</span></span><span class="line"><span class="cl">Num epochs:  0.01
</span></span><span class="line"><span class="cl">Devices:     [&#39;horovod/gpu:0&#39;, &#39;horovod/gpu:1&#39;]
</span></span><span class="line"><span class="cl">NUMA bind:   False
</span></span><span class="line"><span class="cl">Data format: NCHW
</span></span><span class="line"><span class="cl">Optimizer:   sgd
</span></span><span class="line"><span class="cl">Variables:   horovod
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">40	images/sec: 154.4 +/- 0.7 (jitter = 4.0)	8.280
</span></span><span class="line"><span class="cl">40	images/sec: 154.4 +/- 0.7 (jitter = 4.1)	8.482
</span></span><span class="line"><span class="cl">50	images/sec: 154.8 +/- 0.6 (jitter = 4.0)	8.397
</span></span><span class="line"><span class="cl">50	images/sec: 154.8 +/- 0.6 (jitter = 4.2)	8.450
</span></span><span class="line"><span class="cl">60	images/sec: 154.5 +/- 0.5 (jitter = 4.1)	8.321
</span></span><span class="line"><span class="cl">60	images/sec: 154.5 +/- 0.5 (jitter = 4.4)	8.349
</span></span><span class="line"><span class="cl">70	images/sec: 154.5 +/- 0.5 (jitter = 4.0)	8.433
</span></span><span class="line"><span class="cl">70	images/sec: 154.5 +/- 0.5 (jitter = 4.4)	8.430
</span></span><span class="line"><span class="cl">80	images/sec: 154.8 +/- 0.4 (jitter = 3.6)	8.199
</span></span><span class="line"><span class="cl">80	images/sec: 154.8 +/- 0.4 (jitter = 3.8)	8.404
</span></span><span class="line"><span class="cl">90	images/sec: 154.6 +/- 0.4 (jitter = 3.7)	8.418
</span></span><span class="line"><span class="cl">90	images/sec: 154.6 +/- 0.4 (jitter = 3.6)	8.459
</span></span><span class="line"><span class="cl">100	images/sec: 154.2 +/- 0.4 (jitter = 4.0)	8.372
</span></span><span class="line"><span class="cl">100	images/sec: 154.2 +/- 0.4 (jitter = 4.0)	8.542
</span></span><span class="line"><span class="cl">----------------------------------------------------------------
</span></span><span class="line"><span class="cl">total images/sec: 308.27
</span></span></code></pre></div><p>For a sample that uses Intel MPI, see:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat examples/pi/pi-intel.yaml
</span></span></code></pre></div><h2 id="exposed-metrics">Exposed Metrics</h2>
<table>
<thead>
<tr>
<th>Metric name</th>
<th>Metric type</th>
<th>Description</th>
<th>Labels</th>
</tr>
</thead>
<tbody>
<tr>
<td>mpi_operator_jobs_created_total</td>
<td>Counter</td>
<td>Counts number of MPI jobs created</td>
<td></td>
</tr>
<tr>
<td>mpi_operator_jobs_successful_total</td>
<td>Counter</td>
<td>Counts number of MPI jobs successful</td>
<td></td>
</tr>
<tr>
<td>mpi_operator_jobs_failed_total</td>
<td>Counter</td>
<td>Counts number of MPI jobs failed</td>
<td></td>
</tr>
<tr>
<td>mpi_operator_job_info</td>
<td>Gauge</td>
<td>Information about MPIJob</td>
<td><code>launcher</code>=&lt;launcher-pod-name&gt; <br> <code>namespace</code>=&lt;job-namespace&gt;</td>
</tr>
</tbody>
</table>
<h3 id="join-metrics">Join Metrics</h3>
<p>With <a href="https://github.com/kubernetes/kube-state-metrics">kube-state-metrics</a>, one can join metrics by labels.
For example <code>kube_pod_info * on(pod,namespace) group_left label_replace(mpi_operator_job_infos, &quot;pod&quot;, &quot;$0&quot;, &quot;launcher&quot;, &quot;.*&quot;)</code></p>
<h2 id="docker-images">Docker Images</h2>
<p>We push Docker images of <a href="https://hub.docker.com/u/mpioperator">mpioperator on Dockerhub</a> for every release.
You can use the following Dockerfile to build the image yourself:</p>
<ul>
<li><a href="https://github.com/kubeflow/mpi-operator/blob/master/Dockerfile">mpi-operator</a></li>
</ul>
<p>Alternative, you can build the image using make:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">make <span class="nv">RELEASE_VERSION</span><span class="o">=</span>dev <span class="nv">IMAGE_NAME</span><span class="o">=</span>registry.example.com/mpi-operator images
</span></span></code></pre></div><p>This will produce an image with the tag <code>registry.example.com/mpi-operator:dev</code>.</p>
<h2 id="contributing">Contributing</h2>
<p>Learn more in <a href="https://github.com/kubeflow/mpi-operator/blob/master/CONTRIBUTING.md">CONTRIBUTING</a>.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0f6575cd7361e2994f36778f82849b99">6 - Job Scheduling</h1>
    <div class="lead">How to schedule a job with gang-scheduling</div>
	<div class="alert alert-warning" role="alert">
  <h4 class="alert-heading">Alpha</h4>
  This Kubeflow component has <b>alpha</b> status with limited support. See the
  <a href="/docs/started/support/#application-status">Kubeflow versioning policies</a>.
  The Kubeflow team is interested in your   
  <a href="https://github.com/kubeflow/training-operator/issues">feedback</a></h4> 
  about the usability of the feature.
</div>
<p>This guide describes how to use <a href="https://github.com/volcano-sh/volcano">volcano scheduler</a> to support gang-scheduling in
Kubeflow, to allow jobs to run multiple pods at the same time.</p>
<h2 id="running-jobs-with-gang-scheduling">Running jobs with gang-scheduling</h2>
<p>To use gang-scheduling, you have to install volcano scheduler in your cluster first as a secondary scheduler of Kubernetes and configure operator to enable gang-scheduling.</p>
<ul>
<li>Follow the <a href="https://github.com/volcano-sh/volcano">instructions in the volcano repository</a> to install Volcano.</li>
<li>Take <code>TFJob</code> for example, enable gang-scheduling in training-operator by setting true to <code>--enable-gang-scheduling</code> flag.</li>
</ul>
<p><strong>Note:</strong> Volcano scheduler and operator in Kubeflow achieve gang-scheduling by using <a href="https://github.com/volcano-sh/volcano/blob/master/pkg/apis/scheduling/types.go">PodGroup</a>. operator will create the PodGroup of the job automatically.</p>
<p>The yaml to use volcano scheduler to schedule your job as a gang is the same as non-gang-scheduler, for example.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;kubeflow.org/v1beta1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;TFJob&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;tfjob-gang-scheduling&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tfReplicaSpecs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">Worker</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">python</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">tf_cnn_benchmarks.py</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">batch_size=32</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">model=resnet50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">variable_update=parameter_server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">flush_stdout=true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">num_gpus=1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">local_parameter_device=cpu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">device=gpu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">data_format=NHWC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.io/kubeflow/tf-benchmarks-gpu:v20171202-bdab599-dirty-284af3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tensorflow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">nvidia.com/gpu</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">workingDir</span><span class="p">:</span><span class="w"> </span><span class="l">/opt/tf-benchmarks/scripts/tf_cnn_benchmarks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">PS</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">python</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- <span class="l">tf_cnn_benchmarks.py</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">batch_size=32</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">model=resnet50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">variable_update=parameter_server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">flush_stdout=true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">num_gpus=1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">local_parameter_device=cpu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">device=cpu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span>- --<span class="l">data_format=NHWC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.io/kubeflow/tf-benchmarks-cpu:v20171202-bdab599-dirty-284af3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tensorflow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">workingDir</span><span class="p">:</span><span class="w"> </span><span class="l">/opt/tf-benchmarks/scripts/tf_cnn_benchmarks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></span></span></code></pre></div><h2 id="about-volcano-scheduler-and-gang-scheduling">About volcano scheduler and gang-scheduling</h2>
<p>With using volcano scheduler to apply gang-scheduling, a job can run only if there are enough resources for all the pods of the job. Otherwise, all the pods will be in pending state waiting for enough resources. For example, if a job requiring N pods is created and there are only enough resources to schedule N-2 pods, then N pods of the job will stay pending.</p>
<p><strong>Note:</strong> when in a high workload, if a pod of the job dies when the job is still running, it might give other pods a chance to occupy the resources and cause deadlock.</p>
<h2 id="troubleshooting">Troubleshooting</h2>
<p>If you keep getting problems related to RBAC in your volcano scheduler.</p>
<p>You can try to add the following rules into your clusterrole of scheduler used by volcano scheduler.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">- apiGroups:
</span></span><span class="line"><span class="cl">  - &#39;*&#39;
</span></span><span class="line"><span class="cl">  resources:
</span></span><span class="line"><span class="cl">  - &#39;*&#39;
</span></span><span class="line"><span class="cl">  verbs:
</span></span><span class="line"><span class="cl">  - &#39;*&#39;
</span></span></code></pre></div>
</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark pt-3 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Kubeflow mailing list" aria-label="Kubeflow mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://www.kubeflow.org/docs/about/community/#kubeflow-mailing-list" aria-label="Kubeflow mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://twitter.com/kubeflow" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://stackoverflow.com/questions/tagged/kubeflow" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/GoogleCloudPlatform/kubeflow-distribution" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://www.kubeflow.org/docs/about/community/#kubeflow-slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-5 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 Google | Documentation Distributed under CC BY 4.0</small>
        <p><small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">Privacy Policy</a></small></p>
	
		<p class="mt-2"><a href="/kubeflow-docs/docs/about/">About</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="/kubeflow-docs/js/main.min.301c0110334bec1b4445867d27dc7dd69b2df859154ccf252005508bc860cc5a.js" integrity="sha256-MBwBEDNL7BtERYZ9J9x91pst&#43;FkVTM8lIAVQi8hgzFo=" crossorigin="anonymous"></script>
<script src='/kubeflow-docs/js/tabpane-persist.js'></script>

  </body>
</html>
